<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L·ªãch S·ª≠ - EternaPicSHT Studio</title>
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/header.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
    <style>
      .history-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
      }

      .history-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 30px;
        color: #222;
      }

      .history-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #e0e0e0;
      }

      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        color: #999;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: #333;
        border-bottom-color: #555;
      }

      .tab-btn:hover {
        color: #555;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .history-section {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 20px;
      }

      .history-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      .history-card {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .history-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      }

      .history-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #e0e0e0;
      }

      .history-info {
        padding: 15px;
      }

      .history-prompt {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .history-time {
        font-size: 12px;
        color: #999;
        margin-bottom: 10px;
      }

      .history-actions {
        display: flex;
        gap: 8px;
      }

      .btn-small {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-small:hover {
        border-color: #555;
        color: #555;
      }

      .btn-delete {
        background: #ffebee;
        border-color: #ef5350;
        color: #ef5350;
      }

      .btn-delete:hover {
        background: #ef5350;
        color: #fff;
      }

      .topup-table {
        width: 100%;
        border-collapse: collapse;
      }

      .topup-table th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        border-bottom: 2px solid #ddd;
      }

      .topup-table td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
      }

      .topup-amount {
        font-weight: 600;
        color: #2ecc71;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-failed {
        background: #f8d7da;
        color: #721c24;
      }

      .empty-message {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .empty-message p {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: #333;
      }

      .stat-label {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      @media (max-width: 768px) {
        .history-container {
          padding: 15px;
          margin: 20px auto;
        }

        .history-title {
          font-size: 22px;
          margin-bottom: 20px;
        }

        .history-grid {
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 15px;
        }

        .history-image {
          height: 150px;
        }

        .stats {
          grid-template-columns: 1fr;
        }

        .tab-btn {
          padding: 10px 16px;
          font-size: 14px;
        }
      }

      @media (max-width: 480px) {
        .history-tabs {
          gap: 5px;
        }

        .tab-btn {
          padding: 10px 12px;
          font-size: 12px;
        }

        .history-grid {
          grid-template-columns: 1fr;
        }

        .topup-table {
          font-size: 12px;
        }

        .topup-table th,
        .topup-table td {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <div class="history-container">
      <h1 class="history-title">üìú L·ªãch S·ª≠</h1>

      <div class="history-tabs">
        <button class="tab-btn active" data-tab="images">üñºÔ∏è ·∫¢nh T·∫°o Ra</button>
        <button class="tab-btn" data-tab="topups">üí≥ L·ªãch S·ª≠ N·∫°p Ti·ªÅn</button>
      </div>

      <!-- Images History Tab -->
      <div class="tab-content active" id="images-tab">
        <div class="history-section">
          <div class="stats" id="image-stats">
            <div class="stat-card">
              <div class="stat-number" id="stat-total">0</div>
              <div class="stat-label">T·ªïng ·∫£nh</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-success">0</div>
              <div class="stat-label">Th√†nh c√¥ng</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-failed">0</div>
              <div class="stat-label">Th·∫•t b·∫°i</div>
            </div>
          </div>

          <div class="history-grid" id="images-list">
            <div class="loading">ƒêang t·∫£i...</div>
          </div>
        </div>
      </div>

      <!-- TopUps History Tab -->
      <div class="tab-content" id="topups-tab">
        <div class="history-section">
          <table class="topup-table" id="topups-list">
            <thead>
              <tr>
                <th>Th·ªùi gian</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Ph∆∞∆°ng th·ª©c</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="topups-body">
              <tr>
                <td colspan="4" style="text-align: center; color: #999;">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="footer"></div>

    <script src="/assets/js/main.js"></script>
    <script>
      // Tab switching
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabName = btn.dataset.tab;
          document.querySelectorAll(".tab-btn").forEach((b) =>
            b.classList.remove("active")
          );
          document.querySelectorAll(".tab-content").forEach((t) =>
            t.classList.remove("active")
          );
          btn.classList.add("active");
          document.getElementById(`${tabName}-tab`).classList.add("active");

          if (tabName === "images") {
            loadImagesHistory();
          } else {
            loadTopupsHistory();
          }
        });
      });

      // Check login
      function checkLogin() {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc");
          window.location.href = "/login.html";
          return false;
        }
        return true;
      }

      // Load images history
      async function loadImagesHistory() {
        if (!checkLogin()) return;

        try {
          const token = localStorage.getItem("token");

          // Load stats
          const statsResponse = await fetch("/api/history/stats", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const stats = await statsResponse.json();
          document.getElementById("stat-total").textContent = stats.total;
          document.getElementById("stat-success").textContent = stats.success;
          document.getElementById("stat-failed").textContent = stats.failed;

          // Load history
          const response = await fetch("/api/history", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const history = await response.json();

          const imagesList = document.getElementById("images-list");

          if (history.length === 0) {
            imagesList.innerHTML =
              '<div class="empty-message"><p>Ch∆∞a c√≥ l·ªãch s·ª≠ t·∫°o ·∫£nh</p></div>';
            return;
          }

          imagesList.innerHTML = history
            .map((item) => {
              const date = new Date(item.createdAt).toLocaleDateString("vi-VN");
              const statusClass =
                item.status === "success" ? "status-success" : "status-failed";

              return `
                <div class="history-card">
                  <img src="${item.outputImagePath}?t=${Date.now()}" alt="Generated" class="history-image" />
                  <div class="history-info">
                    <div class="history-prompt">${item.promptTitle || item.promptName}</div>
                    <div class="history-time">${date}</div>
                    <div class="history-actions">
                      <a href="${item.outputImagePath}" target="_blank" class="btn-small">Xem</a>
                      <button class="btn-small btn-delete" onclick="deleteHistory('${item._id}')">X√≥a</button>
                    </div>
                  </div>
                </div>
              `;
            })
            .join("");
        } catch (error) {
          console.error("L·ªói load history:", error);
          document.getElementById("images-list").innerHTML =
            '<div class="empty-message"><p style="color: #f00;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠</p></div>';
        }
      }

      // Load topups history
      async function loadTopupsHistory() {
        if (!checkLogin()) return;

        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/topup/history", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const topups = await response.json();

          const tbody = document.getElementById("topups-body");

          if (topups.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="text-align: center; color: #999;">Ch∆∞a c√≥ l·ªãch s·ª≠ n·∫°p ti·ªÅn</td></tr>';
            return;
          }

          tbody.innerHTML = topups
            .map((item) => {
              const date = new Date(item.createdAt).toLocaleDateString(
                "vi-VN",
                { year: "numeric", month: "2-digit", day: "2-digit" }
              );
              const statusClass = `status-${item.status}`;
              const statusText =
                item.status === "success"
                  ? "‚úì Th√†nh c√¥ng"
                  : item.status === "pending"
                    ? "‚è≥ Ch·ªù x·ª≠ l√Ω"
                    : "‚úó Th·∫•t b·∫°i";

              return `
                <tr>
                  <td>${date}</td>
                  <td class="topup-amount">${item.amount.toLocaleString()}ƒë</td>
                  <td>${item.method === "momo" ? "üí∞ Momo" : item.method}</td>
                  <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>
              `;
            })
            .join("");
        } catch (error) {
          console.error("L·ªói load topups:", error);
          document.getElementById("topups-body").innerHTML =
            '<tr><td colspan="4" style="text-align: center; color: #f00;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ n·∫°p ti·ªÅn</td></tr>';
        }
      }

      // Delete history
      async function deleteHistory(historyId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ n√†y?")) return;

        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`/api/history/${historyId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            loadImagesHistory();
          } else {
            alert("Kh√¥ng th·ªÉ x√≥a l·ªãch s·ª≠");
          }
        } catch (error) {
          console.error("L·ªói:", error);
          alert("L·ªói khi x√≥a l·ªãch s·ª≠");
        }
      }

      // Load on page load
      document.addEventListener("DOMContentLoaded", () => {
        if (checkLogin()) {
          loadImagesHistory();
        }
      });
    </script>
  </body>
</html>
