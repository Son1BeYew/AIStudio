<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L·ªãch s·ª≠ | EternaPicSHT AI</title>
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/header.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
    <style>
      * {
        box-sizing: border-box;
      }

      .history-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
      }

      .history-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 30px;
        color: #222;
      }

      .history-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #e0e0e0;
      }

      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        color: #999;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: #333;
        border-bottom-color: #555;
      }

      .tab-btn:hover {
        color: #555;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .history-section {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 20px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: #333;
      }

      .stat-label {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      .history-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      .history-card {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s;
      }

      .history-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .history-image-wrapper {
        width: 100%;
        height: 200px;
        overflow: hidden;
        background: #ddd;
      }

      .history-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #f0f0f0;
        transition: opacity 0.3s ease;
      }
      
      .history-image.loading {
        opacity: 0.5;
      }
      
      .history-image.loaded {
        opacity: 1;
      }

      .history-info {
        padding: 15px;
      }

      .history-prompt {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .history-time {
        font-size: 12px;
        color: #999;
        margin-bottom: 12px;
      }

      .history-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 8px;
      }

      .history-actions.full {
        grid-template-columns: 1fr 1fr 1fr 1fr;
      }

      .btn-action {
        padding: 8px 10px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s;
        color: #555;
        text-align: center;
      }

      .btn-action:hover {
        border-color: #555;
        background: #f5f5f5;
      }

      .btn-delete {
        background: #ffebee;
        border-color: #ef5350;
        color: #ef5350;
      }

      .btn-delete:hover {
        background: #ef5350;
        color: #fff;
      }

      .topup-table {
        width: 100%;
        border-collapse: collapse;
      }

      .topup-table th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        border-bottom: 2px solid #ddd;
      }

      .topup-table td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
      }

      .topup-amount {
        font-weight: 600;
        color: #2ecc71;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-failed {
        background: #f8d7da;
        color: #721c24;
      }

      .empty-message {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .empty-message p {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      /* Image Viewer Modal */
      .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .image-modal.active {
        display: flex;
      }

      .image-modal-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .image-modal-img-wrapper {
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        max-width: 100%;
        max-height: calc(90vh - 100px);
      }

      .image-modal-img {
        max-width: 100%;
        max-height: calc(90vh - 100px);
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        transition: opacity 0.3s ease;
        cursor: zoom-in;
        image-rendering: auto;
        user-select: none;
        -webkit-user-drag: none;
      }

      .image-modal-img.zoomed {
        cursor: grab !important;
      }

      .image-modal-img.panning {
        cursor: grabbing !important;
      }

      .image-modal-close {
        position: absolute;
        top: -40px;
        right: -10px;
        background: none;
        border: none;
        color: #fff;
        font-size: 32px;
        cursor: pointer;
        padding: 5px 10px;
        transition: transform 0.2s;
      }

      .image-modal-close:hover {
        transform: scale(1.2);
      }

      .image-modal-controls {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 12px;
        border-radius: 8px;
      }

      .zoom-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .zoom-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .zoom-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .zoom-level {
        color: #fff;
        font-size: 14px;
        min-width: 50px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }

      .image-modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .image-modal-btn.download {
        background: #10b981;
        color: #fff;
      }

      .image-modal-btn.download:hover {
        background: #059669;
      }

      .image-modal-btn.share {
        background: #3b82f6;
        color: #fff;
      }

      .image-modal-btn.share:hover {
        background: #2563eb;
      }

      @media (max-width: 1024px) {
        .history-grid {
          grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
          gap: 18px;
        }

        .stats {
          grid-template-columns: repeat(3, 1fr);
          gap: 15px;
        }
      }

      @media (max-width: 768px) {
        .history-container {
          padding: 15px;
          margin: 20px auto;
        }

        .history-title {
          font-size: 22px;
          margin-bottom: 20px;
        }

        .history-grid {
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 15px;
        }

        .stats {
          grid-template-columns: 1fr;
        }

        .tab-btn {
          padding: 10px 16px;
          font-size: 14px;
        }
      }

      @media (max-width: 480px) {
        .history-grid {
          grid-template-columns: 1fr;
        }

        .stats {
          grid-template-columns: 1fr;
        }

        .topup-table {
          font-size: 12px;
        }

        .topup-table th,
        .topup-table td {
          padding: 8px;
        }

        .tab-btn {
          padding: 10px 12px;
          font-size: 12px;
        }
      }
    </style>
  </head>

  <body>
    <div id="header"></div>

    <div class="history-container">
      <h1 class="history-title">L·ªãch S·ª≠</h1>

      <div class="history-tabs">
        <button class="tab-btn active" data-tab="images">·∫¢nh</button>
        <button class="tab-btn" data-tab="topups">L·ªãch S·ª≠ N·∫°p Ti·ªÅn</button>
      </div>

      <!-- Images History Tab -->
      <div class="tab-content active" id="images-tab">
        <div class="history-section">
          <div class="stats" id="image-stats">
            <div class="stat-card">
              <div class="stat-number" id="stat-total">0</div>
              <div class="stat-label">T·ªïng ·∫£nh</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-success">0</div>
              <div class="stat-label">Th√†nh c√¥ng</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-failed">0</div>
              <div class="stat-label">Th·∫•t b·∫°i</div>
            </div>
          </div>

          <div class="history-grid" id="images-list">
            <div class="loading">ƒêang t·∫£i...</div>
          </div>
          
          <!-- Pagination -->
          <div id="pagination" style="display: none; margin-top: 30px; text-align: center;">
            <button id="loadMoreBtn" style="padding: 12px 30px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
              Xem Th√™m
            </button>
            <div id="loadingMore" style="display: none; margin-top: 10px; color: #999;">
              ƒêang t·∫£i...
            </div>
          </div>
        </div>
      </div>

      <!-- TopUps History Tab -->
      <div class="tab-content" id="topups-tab">
        <div class="history-section">
          <table class="topup-table" id="topups-list">
            <thead>
              <tr>
                <th>Th·ªùi gian</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Ph∆∞∆°ng th·ª©c</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="topups-body">
              <tr>
                <td colspan="4" style="text-align: center; color: #999">
                  ƒêang t·∫£i...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="footer"></div>

    <!-- Image Viewer Modal -->
    <div class="image-modal" id="imageModal">
      <div class="image-modal-content">
        <button class="image-modal-close" onclick="closeImageModal()">
          &times;
        </button>
        <div class="image-modal-img-wrapper" id="imageWrapper">
          <img src="" alt="Preview" class="image-modal-img" id="modalImage" />
        </div>
        <div class="image-modal-controls">
          <button
            class="zoom-btn"
            id="zoomOutBtn"
            onclick="zoomOut()"
            title="Thu nh·ªè"
          >
            ‚àí
          </button>
          <span class="zoom-level" id="zoomLevel">100%</span>
          <button
            class="zoom-btn"
            id="zoomInBtn"
            onclick="zoomIn()"
            title="Ph√≥ng to"
          >
            +
          </button>
          <button
            class="zoom-btn"
            id="zoomResetBtn"
            onclick="zoomReset()"
            title="V·ªÅ m·∫∑c ƒë·ªãnh"
          >
            ‚ü≤
          </button>
        </div>
        <div class="image-modal-actions">
          <button class="image-modal-btn download" id="modalDownloadBtn">
            T·∫£i V·ªÅ
          </button>
          <button class="image-modal-btn share" id="modalShareBtn">
            Chia S·∫ª
          </button>
        </div>
      </div>
    </div>

    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/toast-modal.js"></script>
    <script src="/assets/js/floating-chat-loader.js"></script>
    <script>
      // Tab switching
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabName = btn.dataset.tab;
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((t) => t.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(`${tabName}-tab`).classList.add("active");

          if (tabName === "images") {
            loadImagesHistory();
          } else {
            loadTopupsHistory();
          }
        });
      });

      // Check login
      function checkLogin() {
        const token = localStorage.getItem("token");
        if (!token) {
          showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc", 'error');
          setTimeout(() => window.location.href = "/login.html", 1000);
          return false;
        }
        return true;
      }

      // Pagination state
      let allHistory = [];
      let currentPage = 0;
      const ITEMS_PER_PAGE = 12; // Load 12 ·∫£nh m·ªói l·∫ßn

      // Load images history v·ªõi lazy loading v√† pagination
      async function loadImagesHistory() {
        if (!checkLogin()) return;

        try {
          const token = localStorage.getItem("token");

          // Load stats
          const statsResponse = await fetch("/api/history/stats", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const stats = await statsResponse.json();
          document.getElementById("stat-total").textContent = stats.total;
          document.getElementById("stat-success").textContent = stats.success;
          document.getElementById("stat-failed").textContent = stats.failed;

          // Load history
          const response = await fetch("/api/history", {
            headers: { Authorization: `Bearer ${token}` },
          });
          allHistory = await response.json();

          const imagesList = document.getElementById("images-list");

          if (allHistory.length === 0) {
            imagesList.innerHTML =
              '<div class="empty-message"><p>Ch∆∞a c√≥ l·ªãch s·ª≠ t·∫°o ·∫£nh</p></div>';
            return;
          }

          // Reset v√† load trang ƒë·∫ßu
          currentPage = 0;
          imagesList.innerHTML = '';
          loadMoreImages();
        } catch (error) {
          console.error("L·ªói load history:", error);
          document.getElementById("images-list").innerHTML =
            '<div class="empty-message"><p style="color: #f00;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠</p></div>';
        }
      }

      // Load th√™m ·∫£nh
      function loadMoreImages() {
        const imagesList = document.getElementById("images-list");
        const start = currentPage * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const itemsToShow = allHistory.slice(start, end);

        if (itemsToShow.length === 0) return;

        const newHTML = itemsToShow
          .map((item) => {
              const date = new Date(item.createdAt).toLocaleDateString("vi-VN");
              
              // T·∫°o thumbnail URL nh·ªè ƒë·ªÉ load nhanh
              let thumbnailUrl = item.outputImagePath;
              if (thumbnailUrl.includes('cloudinary.com')) {
                thumbnailUrl = thumbnailUrl.replace('/upload/', '/upload/w_400,h_300,c_fill,q_auto:low,f_auto/');
              }

              return `
                <div class="history-card">
                  <div class="history-image-wrapper">
                    <img 
                      data-src="${thumbnailUrl}" 
                      alt="Generated" 
                      class="history-image loading lazy-load" />
                  </div>
                  <div class="history-info">
                    <div class="history-prompt">${
                      item.promptTitle || item.promptName
                    }</div>
                    <div class="history-time">${date}</div>
                    <div class="history-actions full">
                      <button class="btn-action" onclick="openImageModal('${
                        item.outputImagePath
                      }', '${item.promptName}', '${
                item._id
              }')" title="Xem ·∫£nh">Xem</button>
                      <button class="btn-action" onclick="downloadImage('${
                        item.outputImagePath
                      }', '${item.promptName}')" title="T·∫£i v·ªÅ">T·∫£i V·ªÅ</button>
                      <button class="btn-action" onclick="shareToFacebook('${
                        item._id
                      }')" title="Chia s·∫ª Facebook">Chia S·∫ª</button>
                      <button class="btn-action btn-delete" onclick="deleteHistory('${
                        item._id
                      }')" title="X√≥a">X√≥a</button>
                    </div>
                  </div>
                </div>
              `;
          })
          .join("");

        imagesList.insertAdjacentHTML('beforeend', newHTML);
        currentPage++;

        // Setup lazy loading cho ·∫£nh m·ªõi
        setupLazyLoading();

        // Show/hide pagination
        const pagination = document.getElementById("pagination");
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        
        if (end >= allHistory.length) {
          // ƒê√£ load h·∫øt
          pagination.style.display = 'none';
        } else {
          // C√≤n ·∫£nh ƒë·ªÉ load
          pagination.style.display = 'block';
          loadMoreBtn.onclick = () => {
            document.getElementById("loadingMore").style.display = 'block';
            loadMoreBtn.style.display = 'none';
            
            setTimeout(() => {
              loadMoreImages();
              document.getElementById("loadingMore").style.display = 'none';
              loadMoreBtn.style.display = 'block';
            }, 500);
          };
        }
      }

      // Load topups history
      async function loadTopupsHistory() {
        if (!checkLogin()) return;

        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/topup/history", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const topups = await response.json();

          const tbody = document.getElementById("topups-body");

          if (topups.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="text-align: center; color: #999;">Ch∆∞a c√≥ l·ªãch s·ª≠ n·∫°p ti·ªÅn</td></tr>';
            return;
          }

          tbody.innerHTML = topups
            .map((item) => {
              const date = new Date(item.createdAt).toLocaleDateString(
                "vi-VN",
                { year: "numeric", month: "2-digit", day: "2-digit" }
              );
              const statusClass = `status-${item.status}`;
              const statusText =
                item.status === "success"
                  ? "Th√†nh c√¥ng"
                  : item.status === "pending"
                  ? "Ch·ªù x·ª≠ l√Ω"
                  : "Th·∫•t b·∫°i";

              return `
                <tr>
                  <td>${date}</td>
                  <td class="topup-amount">${item.amount.toLocaleString()}ƒë</td>
                  <td>${item.method === "momo" ? " Momo" : item.method}</td>
                  <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>
              `;
            })
            .join("");
        } catch (error) {
          console.error("L·ªói load topups:", error);
          document.getElementById("topups-body").innerHTML =
            '<tr><td colspan="4" style="text-align: center; color: #f00;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ n·∫°p ti·ªÅn</td></tr>';
        }
      }

      // Delete history
      async function deleteHistory(historyId) {
        showConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ n√†y?", async () => {
          try {
            const token = localStorage.getItem("token");
            const response = await fetch(`/api/history/${historyId}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });

            if (response.ok) {
              showToast("ƒê√£ x√≥a l·ªãch s·ª≠ th√†nh c√¥ng", 'success');
              loadImagesHistory();
            } else {
              showToast("Kh√¥ng th·ªÉ x√≥a l·ªãch s·ª≠", 'error');
            }
          } catch (error) {
            console.error("L·ªói:", error);
            showToast("L·ªói khi x√≥a l·ªãch s·ª≠", 'error');
          }
        }, { danger: true });
      }

      // Download image v·ªõi ch·∫•t l∆∞·ª£ng g·ªëc (kh√¥ng resize)
      async function downloadImage(imagePath, promptName) {
        try {
          // N·∫øu l√† Cloudinary URL, t·∫£i ·∫£nh g·ªëc v·ªõi ch·∫•t l∆∞·ª£ng 100%
          let downloadUrl = imagePath;
          if (imagePath.includes('cloudinary.com')) {
            // T·∫£i ·∫£nh g·ªëc kh√¥ng resize, ch·ªâ optimize quality
            // q_100: ch·∫•t l∆∞·ª£ng 100%
            // fl_preserve_transparency: gi·ªØ transparency
            // Kh√¥ng c√≥ w_ ho·∫∑c h_ ƒë·ªÉ gi·ªØ nguy√™n k√≠ch th∆∞·ªõc g·ªëc
            downloadUrl = imagePath.replace('/upload/', '/upload/q_100,fl_preserve_transparency,fl_attachment/');
            console.log('üì• Downloading original quality image from:', downloadUrl);
          }

          // Show loading toast
          showToast("‚è≥ ƒêang t·∫£i ·∫£nh ch·∫•t l∆∞·ª£ng g·ªëc...", 'info');

          // Fetch the image as a blob
          const response = await fetch(downloadUrl);
          if (!response.ok) {
            throw new Error("Failed to fetch image");
          }

          const blob = await response.blob();
          const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
          console.log(`üì¶ Downloaded image size: ${sizeMB}MB`);

          // Create an object URL for the blob
          const blobUrl = URL.createObjectURL(blob);

          // Create download link
          const link = document.createElement("a");
          link.href = blobUrl;
          link.download = `${promptName || "generated"}_ORIGINAL_${Date.now()}.jpg`;

          // Trigger download
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Clean up the object URL after a short delay
          setTimeout(() => {
            URL.revokeObjectURL(blobUrl);
          }, 100);

          showToast(`‚úÖ ƒê√£ t·∫£i ·∫£nh g·ªëc th√†nh c√¥ng! (${sizeMB}MB)`, 'success');
        } catch (error) {
          console.error("Error downloading image:", error);
          showToast("‚ùå Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i sau.", 'error');
        }
      }

      // Share to Facebook
      function shareToFacebook(historyId) {
        // D√πng trang share v·ªõi Open Graph meta tags ƒë·ªÉ hi·ªÉn th·ªã t√™n website
        // S·ª≠ d·ª•ng URL public (ngrok/production) ƒë·ªÉ Facebook c√≥ th·ªÉ crawl ƒë∆∞·ª£c
        const backendUrl =
          "https://fidgetingly-unrefreshed-jeramy.ngrok-free.dev";
        const shareUrl = backendUrl + "/share/" + historyId;
        const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(
          shareUrl
        )}`;
        window.open(facebookUrl, "facebook-share", "width=600,height=400");
      }

      // Image Modal Functions
      let currentImagePath = "";
      let currentPromptName = "";
      let currentHistoryId = "";
      let currentZoom = 1;
      const MIN_ZOOM = 0.5;
      const MAX_ZOOM = 2;
      const ZOOM_STEP = 0.25;
      
      // Pan/Drag state
      let isPanning = false;
      let startX = 0;
      let startY = 0;
      let translateX = 0;
      let translateY = 0;

      function updateZoomDisplay() {
        document.getElementById("zoomLevel").textContent =
          Math.round(currentZoom * 100) + "%";
        document.getElementById("zoomOutBtn").disabled =
          currentZoom <= MIN_ZOOM;
        document.getElementById("zoomInBtn").disabled = currentZoom >= MAX_ZOOM;

        const modalImg = document.getElementById("modalImage");
        modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;

        if (currentZoom > 1) {
          modalImg.classList.add("zoomed");
          modalImg.style.cursor = 'grab';
        } else {
          modalImg.classList.remove("zoomed");
          modalImg.style.cursor = 'zoom-in';
          // Reset position khi zoom out v·ªÅ 1x
          translateX = 0;
          translateY = 0;
        }
      }

      function zoomIn() {
        if (currentZoom < MAX_ZOOM) {
          currentZoom = Math.min(currentZoom + ZOOM_STEP, MAX_ZOOM);
          updateZoomDisplay();
        }
      }

      function zoomOut() {
        if (currentZoom > MIN_ZOOM) {
          currentZoom = Math.max(currentZoom - ZOOM_STEP, MIN_ZOOM);
          updateZoomDisplay();
        }
      }

      function zoomReset() {
        currentZoom = 1;
        translateX = 0;
        translateY = 0;
        updateZoomDisplay();
      }
      
      // Pan/Drag functionality
      function setupPanDrag() {
        const modalImg = document.getElementById("modalImage");
        
        // Mouse events
        modalImg.addEventListener('mousedown', (e) => {
          if (currentZoom > 1) {
            isPanning = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            modalImg.classList.add('panning');
            e.preventDefault();
          }
        });
        
        document.addEventListener('mousemove', (e) => {
          if (isPanning) {
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            
            // Update transform tr·ª±c ti·∫øp kh√¥ng qua transition
            const modalImg = document.getElementById("modalImage");
            modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (isPanning) {
            isPanning = false;
            const modalImg = document.getElementById("modalImage");
            modalImg.classList.remove('panning');
          }
        });
        
        // Touch events for mobile
        modalImg.addEventListener('touchstart', (e) => {
          if (currentZoom > 1 && e.touches.length === 1) {
            isPanning = true;
            startX = e.touches[0].clientX - translateX;
            startY = e.touches[0].clientY - translateY;
            modalImg.classList.add('panning');
            e.preventDefault();
          }
        });
        
        modalImg.addEventListener('touchmove', (e) => {
          if (isPanning && e.touches.length === 1) {
            e.preventDefault();
            translateX = e.touches[0].clientX - startX;
            translateY = e.touches[0].clientY - startY;
            
            // Update transform tr·ª±c ti·∫øp
            modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
          }
        });
        
        modalImg.addEventListener('touchend', () => {
          isPanning = false;
          modalImg.classList.remove('panning');
        });
      }

      function openImageModal(imagePath, promptName, historyId) {
        currentImagePath = imagePath;
        currentPromptName = promptName;
        currentHistoryId = historyId;
        currentZoom = 1;

        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");

        // Load ·∫£nh 2K tr·ª±c ti·∫øp (c√¢n b·∫±ng gi·ªØa ch·∫•t l∆∞·ª£ng v√† t·ªëc ƒë·ªô)
        let displayUrl = imagePath;
        
        if (imagePath.includes('cloudinary.com')) {
          // 2K resolution (2048px) - ƒë·ªß n√©t, load nhanh h∆°n 4K
          // q_auto:good: ch·∫•t l∆∞·ª£ng t·ªët nh∆∞ng file nh·ªè h∆°n q_100
          displayUrl = imagePath.replace('/upload/', '/upload/w_2048,q_auto:good,f_auto/');
          console.log('üñºÔ∏è Loading 2K quality image:', displayUrl);
        }

        // Show loading indicator
        modalImg.style.opacity = '0.5';
        modalImg.src = displayUrl;
        
        // Remove loading when image loaded
        modalImg.onload = () => {
          modalImg.style.opacity = '1';
          console.log('‚úÖ Image loaded successfully');
        };
        
        modalImg.onerror = () => {
          modalImg.style.opacity = '1';
          console.error('‚ùå Failed to load image');
          showToast('Kh√¥ng th·ªÉ t·∫£i ·∫£nh', 'error');
        };
        
        // Reset transform
        translateX = 0;
        translateY = 0;
        modalImg.style.transform = "scale(1)";
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
        updateZoomDisplay();

        // Set up button handlers
        document.getElementById("modalDownloadBtn").onclick = () => {
          downloadImage(currentImagePath, currentPromptName);
        };

        document.getElementById("modalShareBtn").onclick = () => {
          shareToFacebook(currentHistoryId);
        };
      }

      function closeImageModal() {
        const modal = document.getElementById("imageModal");
        modal.classList.remove("active");
        document.body.style.overflow = "";
        // Reset zoom and pan
        currentZoom = 1;
        translateX = 0;
        translateY = 0;
        currentZoom = 1;
        document.getElementById("modalImage").style.transform = "scale(1)";
      }

      // Close modal on background click
      document.getElementById("imageModal").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) {
          closeImageModal();
        }
      });

      // Close modal on Escape key, zoom with +/-
      document.addEventListener("keydown", (e) => {
        const modal = document.getElementById("imageModal");
        if (!modal.classList.contains("active")) return;

        if (e.key === "Escape") {
          closeImageModal();
        } else if (e.key === "+" || e.key === "=") {
          zoomIn();
        } else if (e.key === "-") {
          zoomOut();
        } else if (e.key === "0") {
          zoomReset();
        }
      });

      // Zoom with mouse wheel
      document.getElementById("imageModal").addEventListener("wheel", (e) => {
        e.preventDefault();
        if (e.deltaY < 0) {
          zoomIn();
        } else {
          zoomOut();
        }
      });

      // Double click to toggle zoom
      document.getElementById("modalImage").addEventListener("dblclick", () => {
        if (currentZoom === 1) {
          currentZoom = 2;
        } else {
          currentZoom = 1;
        }
        updateZoomDisplay();
      });

      // Lazy loading images v·ªõi Intersection Observer
      function setupLazyLoading() {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              const src = img.getAttribute('data-src');
              
              if (src) {
                img.src = src;
                img.classList.remove('loading');
                img.classList.add('loaded');
                img.removeAttribute('data-src');
                observer.unobserve(img);
              }
            }
          });
        }, {
          rootMargin: '50px' // Load tr∆∞·ªõc 50px
        });

        // Observe t·∫•t c·∫£ ·∫£nh lazy-load
        document.querySelectorAll('.lazy-load').forEach(img => {
          imageObserver.observe(img);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (checkLogin()) {
          loadImagesHistory().then(() => {
            // Setup lazy loading sau khi load xong HTML
            setupLazyLoading();
          });
        }
        
        // Setup pan/drag functionality
        setupPanDrag();
      });
    </script>
  </body>
</html>
