<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Management - Đơn giản</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
      }

      .page-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .page-header h1 {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(26, 26, 26, 0.3);
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #1e293b;
      }

      .btn-secondary:hover {
        background: #cbd5e1;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .stat-title {
        font-size: 14px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
      }

      .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .stat-icon.blue {
        background: #dbeafe;
        color: #3b82f6;
      }
      .stat-icon.green {
        background: #d1fae5;
        color: #10b981;
      }
      .stat-icon.red {
        background: #fee2e2;
        color: #ef4444;
      }
      .stat-icon.purple {
        background: #ede9fe;
        color: #8b5cf6;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
      }

      .stat-change {
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .stat-change.positive {
        color: #10b981;
      }
      .stat-change.negative {
        color: #ef4444;
      }

      /* Filter Section */
      .filter-section {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-input,
      .filter-select {
        padding: 10px 15px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
      }

      .filter-input {
        width: 250px;
      }

      .filter-select {
        min-width: 150px;
      }

      /* Image Grid */
      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .image-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .image-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .image-container {
        position: relative;
        width: 100%;
        height: 200px;
        overflow: hidden;
        background: #f8fafc;
      }

      .image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
      }

      .image-info {
        padding: 15px;
      }

      .image-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: #1e293b;
        font-size: 15px;
      }

      .image-meta {
        font-size: 14px;
        color: #64748b;
        margin-bottom: 5px;
      }

      .image-meta i {
        width: 16px;
        margin-right: 6px;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
      }

      .status-badge.success {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.failed {
        background: #fee2e2;
        color: #991b1b;
      }

      .error-message {
        margin-top: 10px;
        padding: 8px;
        background: #fee2e2;
        border-radius: 6px;
        font-size: 12px;
        color: #991b1b;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
        font-size: 16px;
      }

      .loading i {
        font-size: 24px;
        margin-bottom: 15px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: #374151;
      }

      .empty-state p {
        font-size: 14px;
        max-width: 400px;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="page-container">
      <!-- Page Header -->
      <div class="page-header">
        <h1>
          <i class="fas fa-photo-video"></i>
          Content Management
        </h1>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="refreshImages()">
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Tổng Ảnh</div>
            <div class="stat-icon blue">
              <i class="fas fa-images"></i>
            </div>
          </div>
          <div class="stat-value" id="totalImages">0</div>
          <div class="stat-change positive">
            <i class="fas fa-chart-line"></i>
            <span id="imagesChange">+0 hôm nay</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Thành Công</div>
            <div class="stat-icon green">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
          <div class="stat-value" id="successImages">0</div>
          <div class="stat-change positive">
            <i class="fas fa-check"></i>
            <span>Tạo thành công</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Thất Bại</div>
            <div class="stat-icon red">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
          <div class="stat-value" id="failedImages">0</div>
          <div class="stat-change negative">
            <i class="fas fa-times"></i>
            <span>Lỗi tạo</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Người Dùng</div>
            <div class="stat-icon purple">
              <i class="fas fa-users"></i>
            </div>
          </div>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-change positive">
            <i class="fas fa-user-plus"></i>
            <span>Đã tạo ảnh</span>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <input
          type="text"
          class="filter-input"
          placeholder="Tìm kiếm theo user, prompt..."
          id="searchInput"
        />
        <select class="filter-select" id="statusFilter">
          <option value="">Tất cả trạng thái</option>
          <option value="success">Thành công</option>
          <option value="failed">Thất bại</option>
        </select>
        <select class="filter-select" id="modelFilter">
          <option value="">Tất cả models</option>
          <option value="nano-banana">Basic AI</option>
          <option value="gemini-2.0-flash">Pro AI</option>
          <option value="gemini-3-pro">Ultra AI</option>
        </select>
        <select class="filter-select" id="dateFilter">
          <option value="">Tất cả thời gian</option>
          <option value="today">Hôm nay</option>
          <option value="7days">7 ngày qua</option>
          <option value="30days">30 ngày qua</option>
        </select>
      </div>

      <!-- Image Gallery -->
      <div class="table-container">
        <div class="table-header">
          <div class="table-title">
            Danh sách ảnh (<span id="totalImages">0</span> ảnh)
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshImages()">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
          </div>
        </div>
        <div id="imageGalleryContainer">
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <div>Đang tải dữ liệu...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      let allImages = [];
      let filteredImages = [];

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadImages();

        // Event listeners for filters
        document
          .getElementById("searchInput")
          .addEventListener("input", debounce(applyFilters, 300));
        document
          .getElementById("statusFilter")
          .addEventListener("change", applyFilters);
        document
          .getElementById("modelFilter")
          .addEventListener("change", applyFilters);
        document
          .getElementById("dateFilter")
          .addEventListener("change", applyFilters);
      });

      // Debounce function
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Load images from content management endpoint
      async function loadImages() {
        const container = document.getElementById("imageGalleryContainer");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner"></i><div>Đang tải dữ liệu...</div></div>';

        try {
          // Try content management endpoint first
          let response = await fetch(
            "/api/admin/content-management/media-library",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (response.ok) {
            const data = await response.json();
            allImages = (data.images || []).map((item) => ({
              _id: item._id,
              localPath:
                item.outputImagePath ||
                item.localPath ||
                item.outputImageUrl ||
                `/outputs/${
                  item.outputImagePath?.split("/").pop() || item._id
                }.jpg`,
              promptName: item.promptName || item.promptTitle || "Unknown",
              userEmail: item.userEmail || item.userId?.email || "Unknown",
              model: item.model || "nano-banana",
              createdAt: item.createdAt,
              status: item.status || "success",
              errorMessage: item.errorMessage || "",
            }));
          } else {
            // Fallback 1: try to get sample data from debug endpoint
            response = await fetch("/api/admin/content-management/debug-check");
            if (response.ok) {
              const debugData = await response.json();
              allImages = debugData.sampleImages || [];
              console.log(
                "Loaded sample data from debug endpoint:",
                debugData.totalCount,
                "total images"
              );
            } else {
              // Fallback 2: try public endpoint (no auth required)
              response = await fetch(
                "/api/admin/content-management/public-images"
              );
              if (response.ok) {
                const publicData = await response.json();
                allImages = publicData.images || [];
                console.log(
                  "Loaded data from public endpoint:",
                  publicData.total || publicData.images.length,
                  "total images"
                );
              } else {
                throw new Error(
                  "No authentication and no fallback data available"
                );
              }
            }
          }

          filteredImages = [...allImages];
          renderImages();
          updateStatistics();
        } catch (error) {
          console.error("Error loading images:", error);
          // Show demo data for testing
          allImages = [
            {
              _id: "demo1",
              localPath: "/assets/images/logo.png",
              promptName: "Demo Image 1",
              userEmail: "demo@example.com",
              model: "nano-banana",
              createdAt: new Date().toISOString(),
              status: "success",
            },
            {
              _id: "demo2",
              localPath: "/assets/images/logo.png",
              promptName: "Demo Image 2",
              userEmail: "demo2@example.com",
              model: "gemini-2.0-flash",
              createdAt: new Date(Date.now() - 86400000).toISOString(),
              status: "failed",
              errorMessage: "Sample error message",
            },
          ];

          filteredImages = [...allImages];
          renderImages();
          updateStatistics();

          // Show notification that demo data is being used
          container.innerHTML =
            container.innerHTML +
            `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 20px; text-align: center;">
                        <i class="fas fa-info-circle" style="color: #f59e0b;"></i>
                        <span style="color: #92400e; margin-left: 8px;">Đang hiển thị dữ liệu mẫu. Vui lòng đăng nhập để xem dữ liệu thật.</span>
                    </div>
                `;
        }
      }

      // Apply filters
      function applyFilters() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        const modelFilter = document.getElementById("modelFilter").value;
        const dateFilter = document.getElementById("dateFilter").value;

        filteredImages = allImages.filter((image) => {
          // Search filter
          if (searchTerm) {
            const matchesSearch =
              image.promptName.toLowerCase().includes(searchTerm) ||
              image.userEmail.toLowerCase().includes(searchTerm);
            if (!matchesSearch) return false;
          }

          // Status filter
          if (statusFilter && image.status !== statusFilter) return false;

          // Model filter
          if (modelFilter && image.model !== modelFilter) return false;

          // Date filter
          if (dateFilter) {
            const imageDate = new Date(image.createdAt);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let startDate;
            switch (dateFilter) {
              case "today":
                startDate = today;
                break;
              case "7days":
                startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                break;
              case "30days":
                startDate = new Date(
                  today.getTime() - 30 * 24 * 60 * 60 * 1000
                );
                break;
            }

            if (startDate && imageDate < startDate) return false;
          }

          return true;
        });

        renderImages();
      }

      // Update statistics - fetch from API
      async function updateStatistics() {
        try {
          const response = await fetch(
            "/api/admin/content-management/content-statistics",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (response.ok) {
            const stats = await response.json();
            const totalImages = allImages.length;
            const successImages = allImages.filter(
              (img) => img.status === "success"
            ).length;
            const failedImages = allImages.filter(
              (img) => img.status === "failed"
            ).length;
            const uniqueUsers = [
              ...new Set(allImages.map((img) => img.userEmail)),
            ].length;

            document.getElementById("totalImages").textContent =
              stats.totalImages || totalImages;
            document.getElementById("successImages").textContent =
              stats.successImages || successImages;
            document.getElementById("failedImages").textContent =
              stats.failedImages || failedImages;
            document.getElementById("totalUsers").textContent = uniqueUsers;
            document.getElementById("imagesChange").textContent =
              stats.imagesChange || `+${successImages} hôm nay`;
          } else {
            // Fallback to local calculation
            const totalImages = allImages.length;
            const successImages = allImages.filter(
              (img) => img.status === "success"
            ).length;
            const failedImages = allImages.filter(
              (img) => img.status === "failed"
            ).length;
            const uniqueUsers = [
              ...new Set(allImages.map((img) => img.userEmail)),
            ].length;

            document.getElementById("totalImages").textContent = totalImages;
            document.getElementById("successImages").textContent =
              successImages;
            document.getElementById("failedImages").textContent = failedImages;
            document.getElementById("totalUsers").textContent = uniqueUsers;
            document.getElementById(
              "imagesChange"
            ).textContent = `+${successImages} hôm nay`;
          }
        } catch (error) {
          console.error("Error updating statistics:", error);
          // Fallback to local calculation
          const totalImages = allImages.length;
          const successImages = allImages.filter(
            (img) => img.status === "success"
          ).length;
          const failedImages = allImages.filter(
            (img) => img.status === "failed"
          ).length;
          const uniqueUsers = [
            ...new Set(allImages.map((img) => img.userEmail)),
          ].length;

          document.getElementById("totalImages").textContent = totalImages;
          document.getElementById("successImages").textContent = successImages;
          document.getElementById("failedImages").textContent = failedImages;
          document.getElementById("totalUsers").textContent = uniqueUsers;
          document.getElementById(
            "imagesChange"
          ).textContent = `+${successImages} hôm nay`;
        }
      }

      // Render images
      function renderImages() {
        const container = document.getElementById("imageGalleryContainer");

        // Update total count
        document.getElementById("totalImages").textContent =
          filteredImages.length;

        if (filteredImages.length === 0) {
          container.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <i class="fas fa-images"></i>
                        <h3>Không có ảnh nào</h3>
                        <p>Không tìm thấy ảnh nào phù hợp với bộ lọc hiện tại.</p>
                    </div>
                `;
          return;
        }

        const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    ${filteredImages
                      .map(
                        (image) => `
                        <div class="image-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;">
                            <div class="image-container" style="position: relative; width: 100%; height: 200px; overflow: hidden; background: #f8fafc;">
                                <img src="${image.localPath}"
                                     alt="Generated image"
                                     style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                                     onclick="window.open('${
                                       image.localPath
                                     }', '_blank')"
                                     onerror="this.src='/assets/images/logo.png'">
                                <div style="position: absolute; top: 10px; right: 10px;">
                                    <span class="status-badge ${
                                      image.status === "success"
                                        ? "success"
                                        : "failed"
                                    }">
                                            ${
                                              image.status === "success"
                                                ? "Thành công"
                                                : "Lỗi"
                                            }
                                        </span>
                                </div>
                            </div>
                            <div class="image-info" style="padding: 15px;">
                                <div class="image-title" style="font-weight: 600; margin-bottom: 8px; color: #1e293b; font-size: 15px;">${
                                  image.promptName
                                }</div>
                                <div class="image-meta" style="font-size: 14px; color: #64748b; margin-bottom: 5px;">
                                    <i class="fas fa-user" style="width: 16px; margin-right: 6px;"></i> ${
                                      image.userEmail
                                    }
                                </div>
                                <div class="image-meta" style="font-size: 13px; color: #64748b; margin-bottom: 5px;">
                                    <i class="fas fa-robot" style="width: 16px; margin-right: 6px;"></i> ${getModelName(
                                      image.model
                                    )}
                                </div>
                                <div class="image-meta" style="font-size: 13px; color: #64748b;">
                                    <i class="fas fa-calendar" style="width: 16px; margin-right: 6px;"></i> ${formatDate(
                                      image.createdAt
                                    )}
                                </div>
                                ${
                                  image.status === "failed" &&
                                  image.errorMessage
                                    ? `
                                    <div class="error-message" style="margin-top: 10px; padding: 8px; background: #fee2e2; border-radius: 6px; font-size: 12px; color: #991b1b;">
                                        <i class="fas fa-exclamation-triangle"></i> ${image.errorMessage}
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;

        container.innerHTML = html;
      }

      // Helper functions
      function getModelName(model) {
        const modelNames = {
          "nano-banana": "Basic AI",
          "gemini-2.0-flash": "Pro AI",
          "gemini-3-pro": "Ultra AI",
        };
        return modelNames[model] || model;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return (
          date.toLocaleDateString("vi-VN") +
          " " +
          date.toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit",
          })
        );
      }

      function refreshImages() {
        loadImages();
      }
    </script>
  </body>
</html>
