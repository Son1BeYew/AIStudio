<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EternaPicSHT Studio</title>
    <link rel="stylesheet" href="assets/css/genr.css" />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/features.css" />
    <link rel="stylesheet" href="/assets/css/hero.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
  </head>
  <body>
    <div id="header"></div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="ascii-art">
        <span class="tab-icon"></span>Tạo ASCII Art
      </button>
      <button class="tab-button" data-tab="background">
        <span class="tab-icon"></span>Tạo Ảnh Bối Cảnh
      </button>
      <button class="tab-button" data-tab="outfit">
        <span class="tab-icon"></span>Đổi Trang Phục/Tóc
      </button>
    </div>

    <div class="container">
      <!-- ASCII Art Tab -->
      <div class="tab-content active" id="ascii-art-tab">
        <div class="content-wrapper">
          <!-- Upload Section -->
          <div class="upload-box">
            <h3>Tải ảnh lên</h3>
            <div class="upload-area" id="upload-area">
              <div class="upload-content">
                <img
                  src="https://cdn-icons-png.flaticon.com/512/1829/1829588.png"
                  alt="upload"
                  class="upload-icon"
                />
                <p><strong>Kéo thả hoặc tải ảnh tại đây</strong></p>
                <p class="small">hoặc nhấn để chọn tệp</p>
                <input type="file" id="file-input" hidden accept="image/*" />
                <button class="btn" id="choose-btn">Chọn ảnh</button>
              </div>
            </div>
          </div>

          <!-- Settings Section -->
          <div class="settings-box">
            <h3>Cài đặt</h3>

            <label>Chế độ ảnh</label>
            <select id="prompt-select">
              <option value="">Loading prompts...</option>
            </select>

            <label>Width: 80 characters</label>
            <input type="range" min="40" max="200" value="80" />

            <label>Dáng đứng</label>
            <select>
              <option>Nghiêng về bên trái</option>
              <option>Nghiêng về bên phải</option>
              <option>Nhìn về giữa</option>
            </select>

            <button class="download-btn" id="generate-btn">
              <span></span>Tạo ảnh
            </button>
          </div>
          <div class="output-box">
            <h3>Kết quả</h3>
            <div class="output-area" id="output-area">
              <div class="output-placeholder">
                <p>Ảnh kết quả sẽ xuất hiện tại đây</p>
              </div>
            </div>
            <div class="output-info" id="output-info" style="display: none">
              <p>
                <strong>Chế độ:</strong> <span id="output-prompt-name"></span>
              </p>
              <p>
                <strong>Mô tả:</strong> <span id="output-prompt-title"></span>
              </p>
            </div>
            <button
              class="download-btn download-result"
              id="download-btn"
              style="display: none"
            >
              <span>⬇</span>Tải ảnh
            </button>
          </div>
        </div>
      </div>

      <!-- Background Image Tab -->
      <div class="tab-content" id="background-tab">
        <div class="content-wrapper">
          <div class="upload-box">
            <h3>Tải ảnh lên</h3>
            <div class="upload-area" id="bg-upload-area">
              <div class="upload-content">
                <img
                  src="https://cdn-icons-png.flaticon.com/512/1829/1829588.png"
                  alt="upload"
                  class="upload-icon"
                />
                <p><strong>Kéo thả hoặc tải ảnh tại đây</strong></p>
                <p class="small">hoặc nhấn để chọn tệp</p>
                <input type="file" id="bg-file-input" hidden accept="image/*" />
                <button class="btn" id="bg-choose-btn">Chọn ảnh</button>
              </div>
            </div>
          </div>

          <div class="settings-box">
            <h3>Cài đặt</h3>

            <label>Loại bối cảnh</label>
            <select id="bg-type-select">
              <option value="">Chọn loại bối cảnh</option>
              <option value="nature">Thiên nhiên</option>
              <option value="urban">Thành phố</option>
              <option value="abstract">Trừu tượng</option>
              <option value="fantasy">Giả tưởng</option>
            </select>

            <label>Mô tả bối cảnh</label>
            <textarea
              id="bg-description"
              placeholder="Mô tả bối cảnh mà bạn muốn tạo..."
              rows="4"
            ></textarea>

            <button class="download-btn" id="bg-generate-btn">
              <span></span>Tạo Bối Cảnh
            </button>
          </div>

          <div class="output-box">
            <h3>Kết quả</h3>
            <div class="output-area" id="bg-output-area">
              <div class="output-placeholder">
                <p>Ảnh bối cảnh sẽ xuất hiện tại đây</p>
              </div>
            </div>
            <button
              class="download-btn download-result"
              id="bg-download-btn"
              style="display: none"
            >
              <span>⬇</span>Tải Ảnh
            </button>
          </div>
        </div>
      </div>

      <!-- Outfit Tab -->
      <div class="tab-content" id="outfit-tab">
        <div class="content-wrapper">
          <div class="upload-box">
            <h3>Tải ảnh lên</h3>
            <div class="upload-area" id="outfit-upload-area">
              <div class="upload-content">
                <img
                  src="https://cdn-icons-png.flaticon.com/512/1829/1829588.png"
                  alt="upload"
                  class="upload-icon"
                />
                <p><strong>Kéo thả hoặc tải ảnh tại đây</strong></p>
                <p class="small">hoặc nhấn để chọn tệp</p>
                <input
                  type="file"
                  id="outfit-file-input"
                  hidden
                  accept="image/*"
                />
                <button class="btn" id="outfit-choose-btn">Chọn ảnh</button>
              </div>
            </div>
          </div>

          <div class="settings-box">
            <h3>Cài đặt</h3>

            <label>Loại trang phục/tóc</label>
            <select id="outfit-type-select">
              <option value="">Chọn loại</option>
              <option value="casual">Áo phông thường ngày</option>
              <option value="formal">Áo vest chính thức</option>
              <option value="elegant">Váy lộng lẫy</option>
              <option value="sporty">Áo thể thao</option>
            </select>

            <label>Kiểu tóc</label>
            <select id="outfit-hairstyle-select">
              <option value="">Chọn kiểu tóc</option>
              <option value="long">Tóc dài</option>
              <option value="short">Tóc ngắn</option>
              <option value="curly">Tóc xoăn</option>
              <option value="straight">Tóc thẳng</option>
            </select>

            <label>Mô tả chi tiết</label>
            <textarea
              id="outfit-description"
              placeholder="Mô tả chi tiết về trang phục/tóc mà bạn muốn..."
              rows="4"
            ></textarea>

            <button class="download-btn" id="outfit-generate-btn">
              <span></span>Thay Đổi
            </button>
          </div>

          <div class="output-box">
            <h3>Kết quả</h3>
            <div class="output-area" id="outfit-output-area">
              <div class="output-placeholder">
                <p>Ảnh kết quả sẽ xuất hiện tại đây</p>
              </div>
            </div>
            <button
              class="download-btn download-result"
              id="outfit-download-btn"
              style="display: none"
            >
              <span></span>Tải Ảnh
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Tab switching
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabContents = document.querySelectorAll(".tab-content");

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const tabName = button.dataset.tab;

          // Remove active from all buttons and contents
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          tabContents.forEach((content) => content.classList.remove("active"));

          // Add active to clicked button and corresponding content
          button.classList.add("active");
          document.getElementById(`${tabName}-tab`).classList.add("active");
        });
      });

      // ASCII Art Generation
      const uploadArea = document.getElementById("upload-area");
      const fileInput = document.getElementById("file-input");
      const chooseBtn = document.getElementById("choose-btn");
      const promptSelect = document.getElementById("prompt-select");
      const generateBtn = document.getElementById("generate-btn");
      let selectedFile = null;

      uploadArea.addEventListener("click", () => fileInput.click());
      chooseBtn.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = "#666";
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.style.borderColor = "#ccc";
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      });

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
      });

      function handleFile(file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          uploadArea.innerHTML = `
            <img src="${reader.result}" 
              style="max-width:100%; border-radius:8px; display:block; margin:auto;">
          `;
        };
        reader.readAsDataURL(file);
      }

      // Load prompts từ API
      async function loadPrompts() {
        try {
          const response = await fetch("/api/prompts");
          const prompts = await response.json();
          promptSelect.innerHTML = '<option value="">Chọn chế độ ảnh</option>';
          prompts.forEach((prompt) => {
            if (prompt.isActive) {
              const option = document.createElement("option");
              option.value = prompt.name;
              option.textContent = prompt.title || prompt.name;
              promptSelect.appendChild(option);
            }
          });
        } catch (error) {
          console.error("Lỗi load prompts:", error);
          promptSelect.innerHTML = '<option value="">Lỗi load prompts</option>';
        }
      }

      // Generate ảnh
      let currentImageUrl = null;

      generateBtn.addEventListener("click", async () => {
        if (!selectedFile) {
          alert("Vui lòng chọn ảnh trước");
          return;
        }
        if (!promptSelect.value) {
          alert("Vui lòng chọn chế độ ảnh");
          return;
        }

        const token = localStorage.getItem("token");

        const formData = new FormData();
        formData.append("promptName", promptSelect.value);
        formData.append("image", selectedFile);

        try {
          generateBtn.disabled = true;
          generateBtn.innerHTML = "<span>⏳</span>Đang xử lý...";

          const response = await fetch("/api/ai/generate", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            currentImageUrl = result.localPath;
            displayOutput(result);
          } else {
            alert("Lỗi: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("Lỗi:", error);
          alert("Lỗi khi tạo ảnh: " + error.message);
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = "<span>✨</span>Tạo ảnh";
        }
      });

      // Hiển thị kết quả output
      function displayOutput(result) {
        const outputArea = document.getElementById("output-area");
        const outputInfo = document.getElementById("output-info");
        const downloadBtn = document.getElementById("download-btn");

        // Hiển thị ảnh
        outputArea.innerHTML = `
          <img src="${result.localPath}?t=${Date.now()}" alt="Generated image">
        `;

        // Hiển thị thông tin
        document.getElementById("output-prompt-name").textContent =
          result.promptName;
        document.getElementById("output-prompt-title").textContent =
          result.promptTitle;
        outputInfo.style.display = "block";

        // Hiển thị nút download
        downloadBtn.style.display = "flex";
        downloadBtn.onclick = () =>
          downloadImage(result.localPath, result.promptName);
      }

      // Download ảnh
      function downloadImage(imagePath, promptName) {
        const link = document.createElement("a");
        link.href = imagePath;
        link.download = `${promptName}_${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Load prompts khi page load
      document.addEventListener("DOMContentLoaded", loadPrompts);

      // Background Image Generation
      const bgUploadArea = document.getElementById("bg-upload-area");
      const bgFileInput = document.getElementById("bg-file-input");
      const bgChooseBtn = document.getElementById("bg-choose-btn");
      const bgTypeSelect = document.getElementById("bg-type-select");
      const bgGenerateBtn = document.getElementById("bg-generate-btn");
      let bgSelectedFile = null;

      bgUploadArea.addEventListener("click", () => bgFileInput.click());
      bgChooseBtn.addEventListener("click", () => bgFileInput.click());

      bgUploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        bgUploadArea.style.borderColor = "#666";
      });

      bgUploadArea.addEventListener("dragleave", () => {
        bgUploadArea.style.borderColor = "#ccc";
      });

      bgUploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleBgFile(file);
      });

      bgFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleBgFile(file);
      });

      function handleBgFile(file) {
        bgSelectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          bgUploadArea.innerHTML = `
            <img src="${reader.result}" 
              style="max-width:100%; border-radius:8px; display:block; margin:auto;">
          `;
        };
        reader.readAsDataURL(file);
      }

      bgGenerateBtn.addEventListener("click", async () => {
        if (!bgSelectedFile) {
          alert("Vui lòng chọn ảnh trước");
          return;
        }
        if (!bgTypeSelect.value) {
          alert("Vui lòng chọn loại bối cảnh");
          return;
        }

        const token = localStorage.getItem("token");
        const bgDescription = document.getElementById("bg-description").value;

        const formData = new FormData();
        formData.append("type", bgTypeSelect.value);
        formData.append("description", bgDescription);
        formData.append("image", bgSelectedFile);

        try {
          bgGenerateBtn.disabled = true;
          bgGenerateBtn.innerHTML = "<span>⏳</span>Đang xử lý...";

          const response = await fetch("/api/ai/generate-background", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            displayBgOutput(result);
          } else {
            alert("Lỗi: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("Lỗi:", error);
          alert("Lỗi khi tạo bối cảnh: " + error.message);
        } finally {
          bgGenerateBtn.disabled = false;
          bgGenerateBtn.innerHTML = "<span></span>Tạo Bối Cảnh";
        }
      });

      function displayBgOutput(result) {
        const bgOutputArea = document.getElementById("bg-output-area");
        const bgDownloadBtn = document.getElementById("bg-download-btn");

        bgOutputArea.innerHTML = `
          <img src="${
            result.localPath
          }?t=${Date.now()}" alt="Generated background">
        `;

        bgDownloadBtn.style.display = "flex";
        bgDownloadBtn.onclick = () =>
          downloadImage(result.localPath, `background_${bgTypeSelect.value}`);
      }

      // Outfit Tab
      const outfitUploadArea = document.getElementById("outfit-upload-area");
      const outfitFileInput = document.getElementById("outfit-file-input");
      const outfitChooseBtn = document.getElementById("outfit-choose-btn");
      const outfitTypeSelect = document.getElementById("outfit-type-select");
      const outfitHairstyleSelect = document.getElementById(
        "outfit-hairstyle-select"
      );
      const outfitGenerateBtn = document.getElementById("outfit-generate-btn");
      let outfitSelectedFile = null;

      outfitUploadArea.addEventListener("click", () => outfitFileInput.click());
      outfitChooseBtn.addEventListener("click", () => outfitFileInput.click());

      outfitUploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        outfitUploadArea.style.borderColor = "#666";
      });

      outfitUploadArea.addEventListener("dragleave", () => {
        outfitUploadArea.style.borderColor = "#ccc";
      });

      outfitUploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleOutfitFile(file);
      });

      outfitFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleOutfitFile(file);
      });

      function handleOutfitFile(file) {
        outfitSelectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          outfitUploadArea.innerHTML = `
            <img src="${reader.result}" 
              style="max-width:100%; border-radius:8px; display:block; margin:auto;">
          `;
        };
        reader.readAsDataURL(file);
      }

      outfitGenerateBtn.addEventListener("click", async () => {
        if (!outfitSelectedFile) {
          alert("Vui lòng chọn ảnh trước");
          return;
        }
        if (!outfitTypeSelect.value || !outfitHairstyleSelect.value) {
          alert("Vui lòng chọn loại trang phục và kiểu tóc");
          return;
        }

        const token = localStorage.getItem("token");
        const outfitDescription =
          document.getElementById("outfit-description").value;

        const formData = new FormData();
        formData.append("type", outfitTypeSelect.value);
        formData.append("hairstyle", outfitHairstyleSelect.value);
        formData.append("description", outfitDescription);
        formData.append("image", outfitSelectedFile);

        try {
          outfitGenerateBtn.disabled = true;
          outfitGenerateBtn.innerHTML = "<span>⏳</span>Đang xử lý...";

          const response = await fetch("/api/ai/generate-outfit", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            displayOutfitOutput(result);
          } else {
            alert("Lỗi: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("Lỗi:", error);
          alert("Lỗi khi thay đổi trang phục: " + error.message);
        } finally {
          outfitGenerateBtn.disabled = false;
          outfitGenerateBtn.innerHTML = "<span></span>Thay Đổi";
        }
      });

      function displayOutfitOutput(result) {
        const outfitOutputArea = document.getElementById("outfit-output-area");
        const outfitDownloadBtn = document.getElementById(
          "outfit-download-btn"
        );

        outfitOutputArea.innerHTML = `
          <img src="${result.localPath}?t=${Date.now()}" alt="Generated outfit">
        `;

        outfitDownloadBtn.style.display = "flex";
        outfitDownloadBtn.onclick = () =>
          downloadImage(result.localPath, `outfit_${outfitTypeSelect.value}`);
      }
    </script>

    <!-- Quick Guide Section -->
    <div class="quick-guide">
      <h3>📖 Hướng dẫn nhanh</h3>
      <div class="guide-content">
        <p><strong>Tạo ASCII Art:</strong></p>
        <ol>
          <li>Tải ảnh - Chọn ảnh hoặc kéo thả ảnh vào ô 'Tải ảnh'.</li>
          <li>
            Chế độ ảnh - Hãy nhập một ý tưởng ngắn gọn (VD: 'một hiệp sĩ trong
            rừng rậm').
          </li>
          <li>
            Tạo ảnh - Nhấn nút 'Tạo ảnh' để bắt đầu render (quá trình này mất
            vài phút vì tính toán).
          </li>
          <li>
            Tải về - Khi hoàn thành, nhấn nút 'Tải ảnh' để tải kết quả về máy.
          </li>
        </ol>
        <p style="margin-top: 15px"><strong>Tạo Ảnh Bối Cảnh:</strong></p>
        <ol>
          <li>Chuyển sang tab 'Tạo Ảnh Bối Cảnh'.</li>
          <li>Tải ảnh đầu vào và chọn loại bối cảnh.</li>
          <li>Mô tả chi tiết bối cảnh muốn tạo.</li>
          <li>Nhấn 'Tạo Bối Cảnh' và chờ kết quả.</li>
        </ol>
      </div>
    </div>

    <div id="footer"></div>
    <script src="/assets/js/auth-utils.js"></script>
    <script src="/assets/js/main.js"></script>
  </body>
</html>
