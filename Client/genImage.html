<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EternaPicSHT Studio</title>
    <link rel="stylesheet" href="assets/css/genr.css" />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/features.css" />
    <link rel="stylesheet" href="/assets/css/hero.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
  </head>
  <body>
    <div id="header"></div>
    <div class="container">
      <!-- Upload Section -->
      <div class="upload-box">
        <h3>üì∏ T·∫£i ·∫£nh l√™n</h3>
        <div class="upload-area" id="upload-area">
          <div class="upload-content">
            <img
              src="https://cdn-icons-png.flaticon.com/512/1829/1829588.png"
              alt="upload"
              class="upload-icon"
            />
            <p><strong>K√©o th·∫£ ho·∫∑c t·∫£i ·∫£nh t·∫°i ƒë√¢y</strong></p>
            <p class="small">ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn t·ªáp</p>
            <input type="file" id="file-input" hidden accept="image/*" />
            <button class="btn" id="choose-btn">Ch·ªçn ·∫£nh</button>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="settings-box">
        <h3>‚öôÔ∏è C√†i ƒë·∫∑t</h3>

        <label>Ch·∫ø ƒë·ªô ·∫£nh</label>
        <select id="prompt-select">
          <option value="">Loading prompts...</option>
        </select>

        <label>Width: 80 characters</label>
        <input type="range" min="40" max="200" value="80" />

        <label>D√°ng ƒë·ª©ng</label>
        <select>
          <option>Nghi√™ng v·ªÅ b√™n tr√°i</option>
          <option>Nghi√™ng v·ªÅ b√™n ph·∫£i</option>
          <option>Nh√¨n v·ªÅ gi·ªØa</option>
        </select>

        <button class="download-btn" id="generate-btn">
          <span>‚ú®</span>T·∫°o ·∫£nh
        </button>
      </div>
      <div class="output-box">
        <h3>üé® K·∫øt qu·∫£</h3>
        <div class="output-area" id="output-area">
          <div class="output-placeholder">
            <p>·∫¢nh k·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y</p>
          </div>
        </div>
        <div class="output-info" id="output-info" style="display: none">
          <p><strong>Ch·∫ø ƒë·ªô:</strong> <span id="output-prompt-name"></span></p>
          <p><strong>M√¥ t·∫£:</strong> <span id="output-prompt-title"></span></p>
        </div>
        <button
          class="download-btn download-result"
          id="download-btn"
          style="display: none"
        >
          <span>‚¨áÔ∏è</span>T·∫£i ·∫£nh
        </button>
      </div>
    </div>

    <script>
      const uploadArea = document.getElementById("upload-area");
      const fileInput = document.getElementById("file-input");
      const chooseBtn = document.getElementById("choose-btn");
      const promptSelect = document.getElementById("prompt-select");
      const generateBtn = document.getElementById("generate-btn");
      let selectedFile = null;

      uploadArea.addEventListener("click", () => fileInput.click());
      chooseBtn.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = "#666";
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.style.borderColor = "#ccc";
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      });

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
      });

      function handleFile(file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          uploadArea.innerHTML = `
            <img src="${reader.result}" 
              style="max-width:100%; border-radius:8px; display:block; margin:auto;">
          `;
        };
        reader.readAsDataURL(file);
      }

      // Load prompts t·ª´ API
      async function loadPrompts() {
        try {
          const response = await fetch("/api/prompts");
          const prompts = await response.json();
          promptSelect.innerHTML = '<option value="">Ch·ªçn ch·∫ø ƒë·ªô ·∫£nh</option>';
          prompts.forEach((prompt) => {
            if (prompt.isActive) {
              const option = document.createElement("option");
              option.value = prompt.name;
              option.textContent = prompt.title || prompt.name;
              promptSelect.appendChild(option);
            }
          });
        } catch (error) {
          console.error("L·ªói load prompts:", error);
          promptSelect.innerHTML = '<option value="">L·ªói load prompts</option>';
        }
      }

      // Generate ·∫£nh
      let currentImageUrl = null;

      generateBtn.addEventListener("click", async () => {
        if (!selectedFile) {
          alert("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc");
          return;
        }
        if (!promptSelect.value) {
          alert("Vui l√≤ng ch·ªçn ch·∫ø ƒë·ªô ·∫£nh");
          return;
        }

        const token = localStorage.getItem("token");
        
        const formData = new FormData();
        formData.append("promptName", promptSelect.value);
        formData.append("image", selectedFile);

        try {
          generateBtn.disabled = true;
          generateBtn.innerHTML = "<span>‚è≥</span>ƒêang x·ª≠ l√Ω...";

          const response = await fetch("/api/ai/generate", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            currentImageUrl = result.localPath;
            displayOutput(result);
          } else {
            alert("L·ªói: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("L·ªói:", error);
          alert("L·ªói khi t·∫°o ·∫£nh: " + error.message);
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = "<span>‚ú®</span>T·∫°o ·∫£nh";
        }
      });

      // Hi·ªÉn th·ªã k·∫øt qu·∫£ output
      function displayOutput(result) {
        const outputArea = document.getElementById("output-area");
        const outputInfo = document.getElementById("output-info");
        const downloadBtn = document.getElementById("download-btn");

        // Hi·ªÉn th·ªã ·∫£nh
        outputArea.innerHTML = `
          <img src="${result.localPath}?t=${Date.now()}" alt="Generated image">
        `;

        // Hi·ªÉn th·ªã th√¥ng tin
        document.getElementById("output-prompt-name").textContent =
          result.promptName;
        document.getElementById("output-prompt-title").textContent =
          result.promptTitle;
        outputInfo.style.display = "block";

        // Hi·ªÉn th·ªã n√∫t download
        downloadBtn.style.display = "flex";
        downloadBtn.onclick = () =>
          downloadImage(result.localPath, result.promptName);
      }

      // Download ·∫£nh
      function downloadImage(imagePath, promptName) {
        const link = document.createElement("a");
        link.href = imagePath;
        link.download = `${promptName}_${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Load prompts khi page load
      document.addEventListener("DOMContentLoaded", loadPrompts);
    </script>
    <div id="footer"></div>
    <script src="/assets/js/main.js"></script>
  </body>
</html>
