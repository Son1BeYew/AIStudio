<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nâng cấp Premium | EternaPicSHT AI</title>
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/header.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
    <style>

      .upgrade-container {
        max-width: 650px;
        margin: 40px auto;
        padding: 36px;
        background: white;
        border: 1.5px solid #2d2d2d;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .plan-title {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 30px;
        text-align: center;
      }

      .billing-options {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
      }

      .billing-option {
        flex: 1;
        position: relative;
      }

      .billing-option input[type="radio"] {
        display: none;
      }

      .billing-option label {
        display: block;
        padding: 20px;
        border: 2px solid #e5e5e5;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        text-align: center;
      }

      .billing-option input[type="radio"]:checked + label {
        border-color: #2d2d2d;
        background: #f0f7ff;
      }

      .billing-label {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 5px;
      }

      .billing-price {
        font-size: 14px;
        color: #6b6b6b;
      }

      .save-badge {
        position: absolute;
        top: -8px;
        right: 12px;
        background: #2d2d2d;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .order-details-card {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 16px;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .detail-row:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .detail-label {
        color: #6b6b6b;
        font-size: 15px;
      }

      .detail-value {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 15px;
      }

      .detail-row.total {
        padding-top: 16px;
        margin-top: 8px;
        border-top: 2px solid #e5e5e5;
      }

      .detail-row.total .detail-value {
        font-size: 20px;
        color: #1a1a1a;
      }

      .info-box {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 16px;
      }

      .info-icon {
        color: #6b6b6b;
        font-size: 18px;
        flex-shrink: 0;
      }

      .info-text {
        font-size: 14px;
        color: #6b6b6b;
        line-height: 1.5;
      }

      .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
      }

      .payment-option {
        position: relative;
      }

      .payment-option input[type="radio"] {
        display: none;
      }

      .payment-option label {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border: 2px solid #e5e5e5;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
      }

      .payment-option input[type="radio"]:checked + label {
        border-color: #2d2d2d;
        background: #fafafa;
      }

      .payment-logo {
        width: 40px;
        height: 40px;
        object-fit: contain;
        border-radius: 8px;
      }

      .payment-name {
        font-weight: 500;
        color: #1a1a1a;
        font-size: 15px;
      }

      .email-section {
        margin-bottom: 20px;
      }

      .email-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .email-value {
        color: #1a1a1a;
        font-size: 15px;
      }

      .change-btn {
        color: #2d2d2d;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
      }

      .change-btn:hover {
        text-decoration: underline;
      }

      .verification-box {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .verification-title {
        font-size: 16px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 8px;
      }

      .verification-subtitle {
        font-size: 14px;
        color: #6b6b6b;
        margin-bottom: 20px;
      }

      .code-inputs-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin-bottom: 16px;
      }

      .mail-icon {
        position: relative;
        width: 48px;
        height: 48px;
        flex-shrink: 0;
      }

      .mail-icon svg {
        width: 100%;
        height: 100%;
      }

      .mail-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 16px;
        height: 16px;
        background: #2d9cdb;
        border-radius: 50%;
        border: 2px solid white;
      }

      .code-inputs {
        display: flex;
        gap: 10px;
      }

      .code-input {
        width: 50px;
        height: 56px;
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        border: 2px solid #d4d4d4;
        border-radius: 12px;
        transition: all 0.2s;
      }

      .code-input:focus {
        border-color: #2d2d2d;
        outline: none;
        box-shadow: 0 0 0 3px rgba(45, 45, 45, 0.1);
      }

      .resend-section {
        text-align: center;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .resend-link {
        color: #2d2d2d;
        font-weight: 500;
        cursor: pointer;
      }

      .resend-link:hover {
        text-decoration: underline;
      }

      .sent-message {
        color: #ef4444;
        font-weight: 500;
        display: none;
      }

      .sent-message.show {
        display: inline-block;
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #2d2d2d;
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
      }

      .toast.success {
        background: #10b981;
      }

      .toast.error {
        background: #ef4444;
      }

      .toast.info {
        background: #3b82f6;
      }

      .toast-icon {
        font-size: 20px;
      }

      .toast-message {
        font-size: 14px;
        font-weight: 500;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .toast.hiding {
        animation: slideOut 0.3s ease-out forwards;
      }

      .checkbox-label {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 20px;
        cursor: pointer;
      }

      .checkbox-label input[type="checkbox"] {
        margin-top: 2px;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-text {
        font-size: 14px;
        color: #6b6b6b;
        line-height: 1.6;
      }

      .terms-error {
        display: none;
        color: #ef4444;
        font-size: 14px;
        margin-top: 8px;
        margin-left: 30px;
        font-weight: 500;
      }

      .terms-error.show {
        display: block;
      }

      .subscribe-btn {
        width: 100%;
        padding: 16px;
        background: #2d2d2d;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .subscribe-btn:hover:not(:disabled) {
        background: #1a1a1a;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .subscribe-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      @media (max-width: 640px) {
        .upgrade-container {
          padding: 15px;
        }

        .plan-title {
          font-size: 24px;
        }

        .billing-options {
          flex-direction: column;
        }

        .code-inputs {
          gap: 8px;
        }

        .code-input {
          width: 45px;
          height: 50px;
          font-size: 20px;
        }
      }
    </style>
  </head>

  <body>
    <div id="header"></div>

    <div class="upgrade-container">
      <h1 class="plan-title" id="plan-title">Gói Pro</h1>

      <!-- Billing Options -->
      <div class="billing-options">
        <div class="billing-option">
          <input type="radio" name="billing" value="monthly" id="monthly" checked>
          <label for="monthly">
            <div class="billing-label">Monthly</div>
            <div class="billing-price" id="monthly-price">$20/tháng + thuế</div>
          </label>
        </div>
        <div class="billing-option">
          <span class="save-badge">Tiết kiệm 17%</span>
          <input type="radio" name="billing" value="yearly" id="yearly">
          <label for="yearly">
            <div class="billing-label">Yearly</div>
            <div class="billing-price" id="yearly-price">$200/năm + thuế</div>
          </label>
        </div>
      </div>

      <!-- Order Details -->
      <div class="order-details-card">
        <h3 class="card-title">Chi tiết đơn hàng</h3>
        <div class="detail-row">
          <span class="detail-label" id="order-plan-name">Gói Pro</span>
          <span class="detail-value" id="order-plan-price">1.000đ</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" id="order-billing-type">Hàng tháng</span>
          <span class="detail-value"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tổng phụ</span>
          <span class="detail-value" id="subtotal">1.000đ</span>
        </div>
        <div class="detail-row total">
          <span class="detail-label">Tổng thanh toán hôm nay</span>
          <span class="detail-value" id="total">1.000đ</span>
        </div>

        <div class="info-box">
          <span class="info-icon">ℹ️</span>
          <div class="info-text" id="renewal-info">
            Gói của bạn sẽ tự động gia hạn vào 12/3/2026. Bạn sẽ được tính phí 1.000đ/tháng + thuế.
          </div>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="order-details-card">
        <h3 class="card-title">Phương thức thanh toán</h3>
        <div class="payment-methods">
          <div class="payment-option">
            <input type="radio" name="payment" value="momo" id="momo" checked>
            <label for="momo">
              <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-MoMo-Square-1024x1024.png" alt="MoMo" class="payment-logo">
              <span class="payment-name">Thanh toán qua ví MoMo</span>
            </label>
          </div>
          <div class="payment-option">
            <input type="radio" name="payment" value="vnpay" id="vnpay">
            <label for="vnpay">
              <img src="https://vinadesign.vn/uploads/images/2023/05/vnpay-logo-vinadesign-25-12-57-55.jpg" alt="VNPay" class="payment-logo">
              <span class="payment-name">Thanh toán qua ví VNPAY</span>
            </label>
          </div>
        </div>

        <!-- Email Section -->
        <div class="email-section">
          <div class="email-display">
            <span class="email-value" id="user-email">Loading...</span>
            <a href="#" class="change-btn" onclick="changeEmail(event)">Thay đổi</a>
          </div>
        </div>

        <!-- Verification Box (Hidden initially) -->
        <div class="verification-box" id="verification-box">
          <h4 class="verification-title">Sử dụng thông tin đã lưu</h4>
          <p class="verification-subtitle">Nhập mã được gửi đến <span id="verify-email"></span></p>
          <div class="code-inputs-wrapper">
            <div class="mail-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="#6b6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <div class="mail-badge"></div>
            </div>
            <div class="code-inputs">
              <input type="text" maxlength="1" class="code-input" data-index="0">
              <input type="text" maxlength="1" class="code-input" data-index="1">
              <input type="text" maxlength="1" class="code-input" data-index="2">
              <input type="text" maxlength="1" class="code-input" data-index="3">
              <input type="text" maxlength="1" class="code-input" data-index="4">
              <input type="text" maxlength="1" class="code-input" data-index="5">
            </div>
          </div>
          <div class="resend-section">
            <span class="sent-message" id="sent-message">Đã gửi</span>
            <span class="resend-link" id="resend-link" onclick="resendCode()">Gửi lại mã</span>
          </div>
        </div>
      </div>

      <!-- Terms Checkbox -->
      <div>
        <label class="checkbox-label">
          <input type="checkbox" id="agree-terms">
          <span class="checkbox-text">
            Bạn đồng ý rằng EternaPicSHT sẽ tính phí thẻ của bạn với số tiền trên ngay bây giờ và định kỳ hàng tháng/năm cho đến khi bạn hủy theo điều khoản của chúng tôi. Bạn có thể hủy bất cứ lúc nào trong cài đặt tài khoản.
          </span>
        </label>
        <div class="terms-error" id="terms-error">Vui lòng đồng ý với điều khoản!</div>
      </div>

      <!-- Subscribe Button -->
      <button class="subscribe-btn" id="subscribe-btn" onclick="handleSubscribe()">
        Đăng ký
      </button>
    </div>

    <div id="footer"></div>

    <script src="/assets/js/main.js"></script>
    <script>
      let currentPlan = null;
      let selectedBilling = 'monthly';
      let selectedPayment = 'momo';
      let verificationSent = false;

      // Get plan from URL
      function getPlanFromURL() {
        const hash = window.location.hash;
        const match = hash.match(/#upgrade-(\w+)/);
        return match ? match[1] : 'pro';
      }

      // Load plan data
      async function loadPlanData() {
        const planType = getPlanFromURL();
        
        try {
          const response = await fetch('/api/premium/plans');
          const data = await response.json();
          
          if (data.success && data.plans) {
            currentPlan = data.plans[planType];
            if (currentPlan) {
              updateUI();
            } else {
              showToast('Gói không tồn tại!', 'error');
              setTimeout(() => {
                window.location.href = '/topup.html';
              }, 1000);
            }
          }
        } catch (error) {
          console.error('Error loading plan:', error);
          showToast('Không thể tải thông tin gói!', 'error');
        }
      }

      // Update UI with plan data
      function updateUI() {
        document.getElementById('plan-title').textContent = currentPlan.name;
        updatePricing();
      }

      // Update pricing based on billing cycle
      function updatePricing() {
        const price = currentPlan.price;
        const priceFormatted = price.toLocaleString('vi-VN') + 'đ';
        
        document.getElementById('order-plan-price').textContent = priceFormatted;
        document.getElementById('subtotal').textContent = priceFormatted;
        document.getElementById('total').textContent = priceFormatted;
        
        const billingText = selectedBilling === 'monthly' ? 'Hàng tháng' : 'Hàng năm';
        document.getElementById('order-billing-type').textContent = billingText;
        
        const renewalDate = new Date();
        renewalDate.setMonth(renewalDate.getMonth() + (selectedBilling === 'monthly' ? 1 : 12));
        document.getElementById('renewal-info').textContent = 
          `Gói của bạn sẽ tự động gia hạn vào ${renewalDate.toLocaleDateString('vi-VN')}. Bạn sẽ được tính phí ${priceFormatted}/${selectedBilling === 'monthly' ? 'tháng' : 'năm'} + thuế.`;
      }

      // Billing change handler
      document.querySelectorAll('input[name="billing"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          selectedBilling = e.target.value;
          updatePricing();
        });
      });

      // Payment change handler
      document.querySelectorAll('input[name="payment"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          selectedPayment = e.target.value;
        });
      });

      // Load user email
      function loadUserEmail() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            if (user.email) {
              document.getElementById('user-email').textContent = user.email;
              document.getElementById('verify-email').textContent = user.email;
              return;
            }
          } catch (e) {}
        }
        
        const token = localStorage.getItem('token');
        if (token) {
          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            document.getElementById('user-email').textContent = payload.email;
            document.getElementById('verify-email').textContent = payload.email;
          } catch (e) {}
        }
      }

      function changeEmail(e) {
        e.preventDefault();
        showToast('Chức năng thay đổi email đang được phát triển!', 'info');
      }

      // Setup code inputs
      function setupCodeInputs() {
        const codeInputs = document.querySelectorAll('.code-input');
        codeInputs.forEach((input, index) => {
          input.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            if (e.target.value.length === 1 && index < codeInputs.length - 1) {
              codeInputs[index + 1].focus();
            }
          });
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
              codeInputs[index - 1].focus();
            }
          });
        });
      }

      // Send verification code
      async function sendVerificationCode() {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/premium/send-verification-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ plan: getPlanFromURL() })
          });

          const result = await response.json();
          if (result.success) {
            verificationSent = true;
            // Show "Đã gửi" message on first load
            const sentMessage = document.getElementById('sent-message');
            if (sentMessage) {
              sentMessage.classList.add('show');
              setTimeout(() => {
                sentMessage.classList.remove('show');
              }, 3000);
            }
          } else {
            showToast('Không thể gửi mã: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showToast('Lỗi khi gửi mã xác minh!', 'error');
        }
      }

      async function resendCode() {
        await sendVerificationCode();
        // Show "Đã gửi" message
        const sentMessage = document.getElementById('sent-message');
        sentMessage.classList.add('show');
        
        // Hide after 3 seconds
        setTimeout(() => {
          sentMessage.classList.remove('show');
        }, 3000);
      }

      // Show toast notification
      function showToast(message, type = 'success') {
        // Remove existing toast if any
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }

        // Create toast
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
        
        toast.innerHTML = `
          <span class="toast-icon">${icon}</span>
          <span class="toast-message">${message}</span>
        `;

        document.body.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }

      function getVerificationCode() {
        const codeInputs = document.querySelectorAll('.code-input');
        let code = '';
        codeInputs.forEach(input => code += input.value);
        return code;
      }

      // Handle subscribe
      async function handleSubscribe() {
        const agreeTerms = document.getElementById('agree-terms').checked;
        const termsError = document.getElementById('terms-error');
        
        if (!agreeTerms) {
          termsError.classList.add('show');
          return;
        }

        // Hide error if checkbox is checked
        termsError.classList.remove('show');

        const code = getVerificationCode();
        if (code.length !== 6) {
          showToast('Vui lòng nhập đầy đủ 6 số mã xác minh!', 'error');
          return;
        }

        try {
          const subscribeBtn = document.getElementById('subscribe-btn');
          subscribeBtn.textContent = 'Đang xử lý...';
          subscribeBtn.disabled = true;

          const token = localStorage.getItem('token');
          const response = await fetch('/api/premium/verify-and-upgrade', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              plan: getPlanFromURL(),
              code: code,
              paymentMethod: selectedPayment
            })
          });

          const result = await response.json();

          if (result.success) {
            // Proceed to payment
            if (selectedPayment === 'momo') {
              const paymentResponse = await fetch('/api/premium/purchase', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ plan: getPlanFromURL() })
              });

              const paymentResult = await paymentResponse.json();
              if (paymentResult.success && paymentResult.payUrl) {
                window.location.href = paymentResult.payUrl;
              } else {
                showToast('Không thể tạo thanh toán!', 'error');
              }
            } else {
              showToast('VNPay đang được phát triển!', 'info');
            }
          } else {
            showToast(result.error, 'error');
          }

          subscribeBtn.textContent = 'Đăng ký';
          subscribeBtn.disabled = false;
        } catch (error) {
          console.error('Error:', error);
          showToast('Có lỗi xảy ra!', 'error');
          const subscribeBtn = document.getElementById('subscribe-btn');
          subscribeBtn.textContent = 'Đăng ký';
          subscribeBtn.disabled = false;
        }
      }

      // Check login
      function checkLogin() {
        const token = localStorage.getItem('token');
        if (!token) {
          showToast('Vui lòng đăng nhập!', 'error');
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 1000);
          return false;
        }
        return true;
      }

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        if (checkLogin()) {
          loadPlanData();
          loadUserEmail();
          setupCodeInputs();
          // Auto send verification code when page loads
          sendVerificationCode();

          // Hide error when checkbox is checked
          document.getElementById('agree-terms').addEventListener('change', (e) => {
            if (e.target.checked) {
              document.getElementById('terms-error').classList.remove('show');
            }
          });
        }
      });
    </script>
  </body>
</html>
