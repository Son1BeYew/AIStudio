# MÔ HÌNH CẤU TRÚC HỆ THỐNG - ETERNAPICSHT AI STUDIO

## Tài liệu Kiến trúc Hệ thống

---

## 1. KIẾN TRÚC TỔNG QUAN (SYSTEM ARCHITECTURE)

### 1.1. Sơ đồ Kiến trúc 3-Tier

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                              │
│                         (Tầng Giao diện Người dùng)                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │   Browser    │  │   Mobile     │  │   Tablet     │  │   Desktop   │ │
│  │   (Chrome,   │  │   (Safari,   │  │   (iPad,     │  │   (Windows, │ │
│  │   Firefox)   │  │   Chrome)    │  │   Android)   │  │   macOS)    │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬──────┘ │
│         │                 │                  │                 │         │
│         └─────────────────┴──────────────────┴─────────────────┘         │
│                                    │                                      │
│                              HTTPS/TLS                                    │
│                                    │                                      │
│  ┌─────────────────────────────────▼────────────────────────────────┐   │
│  │                    HTML5 + CSS3 + JavaScript                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │   │
│  │  │  Pages   │  │  Assets  │  │  Scripts │  │   Components     │ │   │
│  │  │ (HTML)   │  │ (CSS/IMG)│  │   (JS)   │  │  (Reusable UI)   │ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘ │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
                                    │
                              REST API / JSON
                                    │
┌───────────────────────────────────▼───────────────────────────────────────┐
│                          APPLICATION LAYER                                 │
│                         (Tầng Xử lý Nghiệp vụ)                            │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                      Node.js + Express.js                          │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                   MIDDLEWARE LAYER                           │ │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────┐ │ │  │
│  │  │  │   CORS   │  │   Auth   │  │   Rate   │  │   Error     │ │ │  │
│  │  │  │  Policy  │  │   JWT    │  │  Limit   │  │  Handler    │ │ │  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └─────────────┘ │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                   ROUTING LAYER                              │ │  │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌───────────┐ │ │  │
│  │  │  │  Auth  │ │   AI   │ │Premium │ │ Topup  │ │  Admin    │ │ │  │
│  │  │  │ Routes │ │ Routes │ │ Routes │ │ Routes │ │  Routes   │ │ │  │
│  │  │  └────────┘ └────────┘ └────────┘ └────────┘ └───────────┘ │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                   CONTROLLER LAYER                           │ │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────────────┐ │ │  │
│  │  │  │   Auth   │ │    AI    │ │ Premium  │ │    Payment     │ │ │  │
│  │  │  │Controller│ │Controller│ │Controller│ │   Controller   │ │ │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └────────────────┘ │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                   SERVICE LAYER                              │ │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────────────┐ │ │  │
│  │  │  │   Email  │ │   File   │ │   AI     │ │   Moderation   │ │ │  │
│  │  │  │ Service  │ │ Service  │ │ Service  │ │    Service     │ │ │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └────────────────┘ │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                   MODEL LAYER (Mongoose)                     │ │  │
│  │  │  ┌──────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌─────────────┐ │ │  │
│  │  │  │ User │ │Premium │ │History │ │Prompt  │ │   Session   │ │ │  │
│  │  │  │Model │ │ Model  │ │ Model  │ │ Model  │ │    Model    │ │ │  │
│  │  │  └──────┘ └────────┘ └────────┘ └────────┘ └─────────────┘ │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
                                    │
                              MongoDB Protocol
                                    │
┌───────────────────────────────────▼───────────────────────────────────────┐
│                            DATA LAYER                                      │
│                         (Tầng Dữ liệu)                                    │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                      MongoDB Atlas (Cloud)                         │  │
│  │                                                                     │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐│  │
│  │  │   Primary    │  │  Secondary   │  │      Secondary           ││  │
│  │  │   Replica    │  │   Replica    │  │       Replica            ││  │
│  │  │   (Master)   │  │   (Slave)    │  │       (Slave)            ││  │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘│  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                    Collections                               │ │  │
│  │  │  • users          • premiums      • histories               │ │  │
│  │  │  • profiles       • prompts       • topups                  │ │  │
│  │  │  • sessions       • outfitstyles  • chatmessages            │ │  │
│  │  │  • announcements  • contentreports                          │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                    Backup & Recovery                         │ │  │
│  │  │  • Automated Daily Backup                                    │ │  │
│  │  │  • Point-in-Time Recovery                                    │ │  │
│  │  │  • 30-day Retention                                          │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. KIẾN TRÚC TÍCH HỢP DỊCH VỤ BÊN NGOÀI

```
┌────────────────────────────────────────────────────────────────────────┐
│                      ETERNAPICSHT AI STUDIO                            │
│                         (Core System)                                  │
└────────────────────────────┬───────────────────────────────────────────┘
                             │
                ┌────────────┴────────────┐
                │                         │
                ▼                         ▼
┌───────────────────────────┐   ┌──────────────────────────┐
│    AI SERVICES            │   │   CLOUD SERVICES         │
├───────────────────────────┤   ├──────────────────────────┤
│                           │   │                          │
│  ┌─────────────────────┐ │   │  ┌────────────────────┐ │
│  │   Replicate API     │ │   │  │   Cloudinary       │ │
│  │  ┌───────────────┐  │ │   │  │  ┌──────────────┐ │ │
│  │  │ nano-banana   │  │ │   │  │  │Image Storage │ │ │
│  │  │ (Basic AI)    │  │ │   │  │  │& CDN         │ │ │
│  │  └───────────────┘  │ │   │  │  └──────────────┘ │ │
│  │  ┌───────────────┐  │ │   │  │  ┌──────────────┐ │ │
│  │  │ Other Models  │  │ │   │  │  │Optimization  │ │ │
│  │  │ (Future)      │  │ │   │  │  │& Transform   │ │ │
│  │  └───────────────┘  │ │   │  │  └──────────────┘ │ │
│  └─────────────────────┘ │   │  └────────────────────┘ │
│                           │   │                          │
│  ┌─────────────────────┐ │   │  ┌────────────────────┐ │
│  │   Google Gemini AI  │ │   │  │  MongoDB Atlas     │ │
│  │  ┌───────────────┐  │ │   │  │  ┌──────────────┐ │ │
│  │  │ Gemini 2.0    │  │ │   │  │  │Database      │ │ │
│  │  │ Flash (Pro)   │  │ │   │  │  │Hosting       │ │ │
│  │  └───────────────┘  │ │   │  │  └──────────────┘ │ │
│  │  ┌───────────────┐  │ │   │  │  ┌──────────────┐ │ │
│  │  │ Gemini 3 Pro  │  │ │   │  │  │Auto Backup   │ │ │
│  │  │ (Max)         │  │ │   │  │  │& Scaling     │ │ │
│  │  └───────────────┘  │ │   │  │  └──────────────┘ │ │
│  │  ┌───────────────┐  │ │   │  └────────────────────┘ │
│  │  │ Chatbot       │  │ │   │                          │
│  │  │ Support       │  │ │   └──────────────────────────┘
│  │  └───────────────┘  │ │
│  └─────────────────────┘ │
│                           │
│  ┌─────────────────────┐ │
│  │  Stability AI       │ │
│  │  (Future)           │ │
│  └─────────────────────┘ │
│                           │
│  ┌─────────────────────┐ │
│  │  Hugging Face       │ │
│  │  (Future)           │ │
│  └─────────────────────┘ │
│                           │
└───────────────────────────┘

                │
                ▼
┌───────────────────────────┐   ┌──────────────────────────┐
│   PAYMENT SERVICES        │   │  COMMUNICATION SERVICES  │
├───────────────────────────┤   ├──────────────────────────┤
│                           │   │                          │
│  ┌─────────────────────┐ │   │  ┌────────────────────┐ │
│  │   MoMo Wallet       │ │   │  │  Gmail SMTP        │ │
│  │  ┌───────────────┐  │ │   │  │  ┌──────────────┐ │ │
│  │  │Payment        │  │ │   │  │  │Welcome Email │ │ │
│  │  │Gateway        │  │ │   │  │  └──────────────┘ │ │
│  │  └───────────────┘  │ │   │  │  ┌──────────────┐ │ │
│  │  ┌───────────────┐  │ │   │  │  │Payment       │ │ │
│  │  │IPN Callback   │  │ │   │  │  │Confirmation  │ │ │
│  │  └───────────────┘  │ │   │  │  └──────────────┘ │ │
│  │  ┌───────────────┐  │ │   │  │  ┌──────────────┐ │ │
│  │  │Signature      │  │ │   │  │  │Premium       │ │ │
│  │  │Verification   │  │ │   │  │  │Expiry Alert  │ │ │
│  │  └───────────────┘  │ │   │  │  └──────────────┘ │ │
│  └─────────────────────┘ │   │  └────────────────────┘ │
│                           │   │                          │
│  ┌─────────────────────┐ │   │  ┌────────────────────┐ │
│  │   VNPay             │ │   │  │  Socket.io         │ │
│  │   (Future)          │ │   │  │  (Real-time Chat)  │ │
│  └─────────────────────┘ │   │  │  (Future)          │ │
│                           │   │  └────────────────────┘ │
└───────────────────────────┘   └──────────────────────────┘
```

---

## 3. LUỒNG XỬ LÝ TẠO ẢNH AI (AI IMAGE GENERATION FLOW)

```
┌──────────┐
│  USER    │
│ (Browser)│
└────┬─────┘
     │
     │ 1. Upload Image + Select Prompt
     ▼
┌─────────────────────────────────────────┐
│         Frontend (Client)               │
│  ┌───────────────────────────────────┐  │
│  │  1. Validate File                 │  │
│  │     - Check file type (jpg/png)   │  │
│  │     - Check file size (<10MB)     │  │
│  │  2. Preview Image                 │  │
│  │  3. Send to Server via AJAX       │  │
│  └───────────────────────────────────┘  │
└────────────────┬────────────────────────┘
                 │
                 │ 2. POST /api/ai/generate-face
                 │    (multipart/form-data)
                 ▼
┌─────────────────────────────────────────┐
│      Backend - Express Server          │
│  ┌───────────────────────────────────┐  │
│  │  Middleware Stack                 │  │
│  │  ├─ CORS Check                    │  │
│  │  ├─ JWT Authentication            │  │
│  │  ├─ Multer File Upload            │  │
│  │  └─ Rate Limiting                 │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  AI Controller                    │  │
│  │  3. Validate Request              │  │
│  │     - Check user logged in        │  │
│  │     - Check prompt exists         │  │
│  │     - Check file uploaded         │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  4. Upload to Cloudinary          │  │
│  │     - Convert to buffer           │  │
│  │     - Upload to cloud             │  │
│  │     - Get secure URL              │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  5. Check User Permissions        │  │
│  │     - Get user premium plan       │  │
│  │     - Check model access          │  │
│  │     - Validate model selection    │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  6. Check Daily Free Quota        │  │
│  │     - Get premium type            │  │
│  │     - Check last reset time       │  │
│  │     - Check remaining quota       │  │
│  │     - Reset if new day            │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│         ┌───────┴────────┐               │
│         ▼                ▼               │
│  ┌──────────────┐  ┌─────────────────┐  │
│  │ Has Free     │  │ No Free Quota   │  │
│  │ Quota        │  │                 │  │
│  │ Use Free     │  │ 7. Check Balance│  │
│  │ Image        │  │    - Get profile│  │
│  └──────┬───────┘  │    - Check fee  │  │
│         │          │    - Deduct fee │  │
│         │          └────────┬────────┘  │
│         │                   │            │
│         └───────┬───────────┘            │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  8. Prepare AI Request            │  │
│  │     - Get prompt text             │  │
│  │     - Convert image to base64     │  │
│  │     - Build request payload       │  │
│  └───────────────────────────────────┘  │
└────────────────┬────────────────────────┘
                 │
                 │ 9. Call AI API
                 ▼
┌─────────────────────────────────────────┐
│      Replicate / Google AI              │
│  ┌───────────────────────────────────┐  │
│  │  10. Process Image                │  │
│  │      - Load model                 │  │
│  │      - Apply prompt               │  │
│  │      - Generate image             │  │
│  │      - Return URL                 │  │
│  └───────────────────────────────────┘  │
└────────────────┬────────────────────────┘
                 │
                 │ 11. Return Image URL
                 ▼
┌─────────────────────────────────────────┐
│      Backend - Express Server          │
│  ┌───────────────────────────────────┐  │
│  │  12. Download Result Image        │  │
│  │      - Fetch from AI URL          │  │
│  │      - Save to temp file          │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  13. Upload to Cloudinary         │  │
│  │      - Upload result image        │  │
│  │      - Get permanent URL          │  │
│  │      - Delete temp file           │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  14. Content Moderation           │  │
│  │      - Calculate AI Safety Score  │  │
│  │      - Determine status           │  │
│  │      - (approved/pending/flagged) │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  15. Save to History              │  │
│  │      - Create History record      │  │
│  │      - Save all metadata          │  │
│  │      - Link to user & prompt      │  │
│  └───────────────────────────────────┘  │
│                 │                        │
│                 ▼                        │
│  ┌───────────────────────────────────┐  │
│  │  16. Return Response              │  │
│  │      - Image URLs                 │  │
│  │      - History ID                 │  │
│  │      - Model info                 │  │
│  │      - Quota info                 │  │
│  └───────────────────────────────────┘  │
└────────────────┬────────────────────────┘
                 │
                 │ 17. JSON Response
                 ▼
┌─────────────────────────────────────────┐
│         Frontend (Client)               │
│  ┌───────────────────────────────────┐  │
│  │  18. Display Result               │  │
│  │      - Show generated image       │  │
│  │      - Enable download button     │  │
│  │      - Update quota display       │  │
│  │      - Show success message       │  │
│  └───────────────────────────────────┘  │
└────────────────┬────────────────────────┘
                 │
                 ▼
           ┌──────────┐
           │  USER    │
           │ (Views   │
           │  Result) │
           └──────────┘
```

---

## 4. LUỒNG THANH TOÁN MOMO (MOMO PAYMENT FLOW)

```
┌──────────┐
│  USER    │
└────┬─────┘
     │ 1. Select Premium Plan (Pro/Max)
     ▼
┌─────────────────────────────────────────┐
│         Frontend - Pricing Page         │
│  • Display plan details                 │
│  • Show pricing                         │
│  • Compare features                     │
└────────────────┬────────────────────────┘
                 │ 2. Click "Mua ngay"
                 ▼
┌─────────────────────────────────────────┐
│      Backend - Premium Controller       │
│  3. POST /api/premium/purchase          │
│     { plan: "pro" }                     │
│                                         │
│  4. Validate Request                    │
│     - Check user logged in              │
│     - Check plan valid                  │
│     - Check not already have this plan  │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      Database - MongoDB                 │
│  5. Create Premium Record               │
│     - status: "pending"                 │
│     - plan: "pro"                       │
│     - price: 199000                     │
│     - duration: 30 days                 │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      Backend - MoMo Integration         │
│  6. Prepare MoMo Request                │
│     - orderId: premium_{id}_{timestamp} │
│     - amount: 199000                    │
│     - orderInfo: "Thanh toan goi Pro"   │
│     - extraData: {premiumId, userId}    │
│                                         │
│  7. Create Signature                    │
│     rawSignature = "accessKey=...&      │
│                     amount=...&..."     │
│     signature = HMAC-SHA256(            │
│                   rawSignature,         │
│                   secretKey)            │
│                                         │
│  8. Send to MoMo API                    │
│     POST https://payment.momo.vn/...    │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│         MoMo Payment Gateway            │
│  9. Process Request                     │
│     - Validate signature                │
│     - Create payment session            │
│     - Generate payUrl                   │
│                                         │
│  10. Return Response                    │
│      { payUrl: "https://..." }          │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      Backend - Premium Controller       │
│  11. Receive payUrl                     │
│  12. Return to Frontend                 │
│      { success: true, payUrl: "..." }   │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│         Frontend - Redirect             │
│  13. Redirect to MoMo payUrl            │
│      window.location.href = payUrl      │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      MoMo Payment Page (External)       │
│  14. User enters payment info           │
│      - Phone number                     │
│      - OTP verification                 │
│      - Confirm payment                  │
└────────────────┬────────────────────────┘
                 │
         ┌───────┴────────┐
         ▼                ▼
    [Success]        [Failed]
         │                │
         │                │
         └────────┬───────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      MoMo - IPN Callback                │
│  15. POST /api/premium/momo-callback    │
│      {                                  │
│        resultCode: 0,  // 0=success     │
│        transId: "...",                  │
│        orderId: "...",                  │
│        signature: "...",                │
│        extraData: "{...}"               │
│      }                                  │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      Backend - MoMo Callback Handler    │
│  16. Verify Signature                   │
│      - Rebuild rawSignature             │
│      - Calculate expected signature     │
│      - Compare with received signature  │
│                                         │
│  17. Check Result Code                  │
│      if (resultCode === 0) {            │
│        // Payment Success               │
│      } else {                           │
│        // Payment Failed                │
│      }                                  │
└────────────────┬────────────────────────┘
                 │
         ┌───────┴────────┐
         ▼                ▼
    [Success]        [Failed]
         │                │
         │                │
         ▼                ▼
┌──────────────┐   ┌──────────────────┐
│ 18. Update   │   │ 19. Update       │
│  Premium     │   │  Premium         │
│  - status:   │   │  - status:       │
│    "active"  │   │    "failed"      │
│  - startDate │   │  - description   │
│  - endDate   │   │                  │
│              │   │                  │
│ 20. Update   │   │                  │
│  User        │   │                  │
│  - hasPremium│   │                  │
│  - premiumType│  │                  │
│  - expiry    │   │                  │
│              │   │                  │
│ 21. Send     │   │                  │
│  Email       │   │                  │
│  Success     │   │                  │
└──────┬───────┘   └────────┬─────────┘
       │                    │
       └────────┬───────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│      MoMo - Redirect User               │
│  22. Redirect to returnUrl              │
│      /topup-result.html?status=success  │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      Frontend - Result Page             │
│  23. Display Result                     │
│      - Success/Failed message           │
│      - Transaction details              │
│      - Premium info                     │
│      - Link to dashboard                │
└────────────────┬────────────────────────┘
                 │
                 ▼
           ┌────��─────┐
           │  USER    │
           │ (Premium │
           │ Activated)│
           └──────────┘
```

---

## 5. KIẾN TRÚC BẢO MẬT (SECURITY ARCHITECTURE)

```
┌────────────────────────────────────────────────────────────────────┐
│                      SECURITY LAYERS                               │
└────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────┐
│  LAYER 1: NETWORK SECURITY                                         │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │
│  │   HTTPS/TLS      │  │   Firewall       │  │   DDoS          │ │
│  │   Encryption     │  │   Rules          │  │   Protection    │ │
│  │   (SSL Cert)     │  │   (Port Filter)  │  │   (Cloudflare)  │ │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘ │
│                                                                     │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│  LAYER 2: APPLICATION SECURITY                                     │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  CORS Policy                                                  │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  Allowed Origins:                                      │  │ │
│  │  │  - http://localhost:5000                               │  │ │
│  │  │  - https://your-domain.com                             │  │ │
│  │  │  Methods: GET, POST, PUT, DELETE, PATCH                │  │ │
│  │  │  Headers: Content-Type, Authorization                  │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Rate Limiting                                                │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  - 100 requests per 15 minutes per IP                  │  │ │
│  │  │  - 10 login attempts per hour                          │  │ │
│  │  │  - 50 AI generation requests per hour                  │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Input Validation & Sanitization                             │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  - Email format validation                             │  │ │
│  │  │  - Password strength check                             │  │ │
│  │  │  - File type & size validation                         │  │ │
│  │  │  - SQL Injection prevention (NoSQL)                    │  │ │
│  │  │  - XSS prevention (sanitize HTML)                      │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│  LAYER 3: AUTHENTICATION & AUTHORIZATION                           │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  JWT Authentication                                           │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  Access Token:                                         │  │ │
│  │  │  - Expires: 1 hour                                     │  │ │
│  │  │  - Payload: {id, email, role, tokenId}                │  │ │
│  │  │  - Algorithm: HS256                                    │  │ │
│  │  │                                                         │  │ │
│  │  │  Refresh Token:                                        │  │ │
│  │  │  - Expires: 7 days                                     │  │ │
│  │  │  - Stored in database                                  │  │ │
│  │  │  - Can be revoked                                      │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  OAuth 2.0 Integration                                        │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  Google OAuth:                                         │  │ │
│  │  │  - Client ID & Secret                                  │  │ │
│  │  │  - Scopes: profile, email                             │  │ │
│  │  │  - Callback URL verification                          │  │ │
│  │  │                                                         │  │ │
│  │  │  Facebook OAuth:                                       │  │ │
│  │  │  - App ID & Secret                                     │  │ │
│  │  │  - Permissions: email, public_profile                 │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Role-Based Access Control (RBAC)                            │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  User Role:                                            │  │ │
│  │  │  - create_image, view_own_history                     │  │ │
│  │  │  - purchase_premium, topup_balance                    │  │ │
│  │  │                                                         │  │ │
│  │  │  Admin Role:                                           │  │ │
│  │  │  - All user permissions +                             │  │ │
│  │  │  - manage_users, manage_prompts                       │  │ │
│  │  │  - moderate_content, view_statistics                  │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│  LAYER 4: DATA SECURITY                                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Password Hashing                                             │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  Algorithm: bcrypt                                     │  │ │
│  │  │  Salt Rounds: 10                                       │  │ │
│  │  │  Example:                                              │  │ │
│  │  │  $2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Sensitive Data Encryption                                    │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  - API Keys (encrypted in .env)                        │  │ │
│  │  │  - Payment credentials                                 │  │ │
│  │  │  - User personal information                           │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Database Security                                            │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │  - MongoDB Atlas with authentication                   │  │ │
│  │  │  - IP Whitelist                                        │  │ │
│  │  │  - Encrypted connections (TLS/SSL)                     │  │ │
│  │  │  - Automated backups                                   │  │ │
│  │  │  - Point-in-time recovery                              │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│  LAYER 5: MONITORING & LOGGING                                     │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Security Logging                                             │ │
│  │  - Failed login attempts                                      │ │
│  │  - Suspicious activities                                      │ │
│  │  - API abuse attempts                                         │ │
│  │  - Payment fraud attempts                                     │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Session Management                                           │ │
│  │  - Track active sessions                                      │ │
│  │  - Device fingerprinting                                      │ │
│  │  - Remote logout capability                                   │ │
│  │  - Session timeout (7 days)                                   │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

---

## 6. KIẾN TRÚC DATABASE (DATABASE ARCHITECTURE)

```
┌────────────────────────────────────────────────────────────────────────┐
│                    MONGODB ATLAS CLUSTER                               │
│                    (Replica Set - 3 Nodes)                             │
└────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│   PRIMARY NODE   │────▶│  SECONDARY NODE  │────▶│  SECONDARY NODE  │
│   (Master)       │     │   (Slave 1)      │     │   (Slave 2)      │
│                  │     │                  │     │                  │
│  Read + Write    │     │  Read Only       │     │  Read Only       │
│  Auto Failover   │     │  Sync from       │     │  Sync from       │
│                  │     │  Primary         │     │  Primary         │
└──────────────────┘     └──────────────────┘     └──────────────────┘
         │                        │                        │
         └────────────────────────┴────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────────┐
│                         DATABASE: StudioAI                             │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │  CORE COLLECTIONS                                                │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │                                                                   │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │ │
│  │  │   users     │  │  profiles   │  │      premiums           │ │ │
│  │  ├─────────────┤  ├─────────────┤  ├─────────────────────────┤ │ │
│  │  │ _id         │  │ _id         │  │ _id                     │ │ │
│  │  │ fullname    │  │ userId  ────┼──┼▶userId                  │ │ │
│  │  │ email       │  │ balance     │  │ plan                    │ │ │
│  │  │ password    │  │ totalTopup  │  │ planName                │ │ │
│  │  │ role        │  │ totalSpent  │  │ price                   │ │ │
│  │  │ hasPremium  │  │ address     │  │ status                  │ │ │
│  │  │ premiumType │  │ city        │  │ startDate               │ │ │
│  │  │ createdAt   │  │ createdAt   │  │ endDate                 │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │ │
│  │         │                                      │                 │ │
│  │         │                                      │                 │ │
│  │         └──────────────┬───────────────────────┘                 │ │
│  │                        │                                         │ │
│  │                        ▼                                         │ │
│  │  ┌─────────────────────────────────────────────────────────┐   │ │
│  │  │                    histories                            │   │ │
│  │  ├─────────────────────────────────────────────────────────┤   │ │
│  │  │ _id                                                     │   │ │
│  │  │ userId ◀────────────────────────────────────────────────┼───┘ │
│  │  │ promptId                                                │     │
│  │  │ promptName                                              │     │
│  │  │ originalImagePath                                       │     │
│  │  │ outputImagePath                                         │     │
│  │  │ model                                                   │     │
│  │  │ status                                                  │     │
│  │  │ moderationStatus                                        │     │
│  │  │ aiSafetyScore                                           │     │
│  │  │ createdAt                                               │     │
│  │  └─────────────────────────────────────────────────────────┘     │
│  │                        │                                         │
│  └────────────────────────┼─────────────────────────────────────────┘
│                           │                                          │
│  ┌────────────────────────┼─────────────────────────────────────────┐
│  │  CONTENT COLLECTIONS   │                                         │
│  ├────────────────────────┼─────────────────────────────────────────┤
│  │                        │                                         │
│  │  ┌─────────────────────▼──────┐  ┌──────────────────────────┐  │
│  │  │       prompts              │  │   prompttrendings        │  │
│  │  ├────────────────────────────┤  ├──────────────────────────┤  │
│  │  │ _id                        │  │ _id                      │  │
│  │  │ name (unique)              │  │ name                     │  │
│  │  │ title                      │  │ title                    │  │
│  │  │ prompt                     │  │ prompt                   │  │
│  │  │ fee                        │  │ fee                      │  │
│  │  │ gender                     │  │ gender                   │  │
│  │  │ isActive                   │  │ isActive                 │  │
│  │  │ category                   │  │ sampleImage              │  │
│  │  │ usageCount                 │  │ likes                    │  │
│  │  │ revenue                    │  │ usageCount               │  │
│  │  └────────────────────────────┘  └──────────────────────────┘  │
│  │                                                                  │
│  │  ┌──────────────────────────────────────────────────────────┐  │
│  │  │              outfitstyles                                │  │
│  │  ├──────────────────────────────────────────────────────────┤  │
│  │  │ _id                                                      │  │
│  │  │ name                                                     │  │
│  │  │ type (clothing/hairstyle)                               │  │
│  │  │ gender                                                   │  │
│  │  │ description                                              │  │
│  │  │ imageUrl                                                 │  │
│  │  │ isActive                                                 │  │
│  │  │ usageCount                                               │  │
│  │  └──────────────────────────────────────────────────────────┘  │
│  └──────────────────────────────────────────────────────────────────┘
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────────┐
│  │  TRANSACTION COLLECTIONS                                         │
│  ├──────────────────────────────────────────────────────────────────┤
│  │                                                                   │
│  │  ┌─────────────────────┐  ┌──────────────────────────────────┐  │
│  │  │      topups         │  │        sessions                  │  │
│  │  ├─────────────────────┤  ├──────────────────────────────────┤  │
│  │  │ _id                 │  │ _id                              │  │
│  │  │ userId              │  │ userId                           │  │
│  │  │ amount              │  │ tokenId (unique)                 │  │
│  │  │ method              │  │ userAgent                        │  │
│  │  │ status              │  │ ipAddress                        │  │
│  │  │ momoTransactionId   │  │ deviceInfo                       │  │
│  │  │ orderId             │  │ isActive                         │  │
│  │  │ createdAt           │  │ createdAt                        │  │
│  │  │ completedAt         │  │ expiresAt                        │  │
│  │  └─────────────────────┘  └──────────────────────────────────┘  │
│  └──────────────────────────────────────────────────────────────────┘
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────────┐
│  │  SUPPORT COLLECTIONS                                             │
│  ├──────────────────────────────────────────────────────────────────┤
│  │                                                                   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐ │
│  │  │  chatmessages    │  │ chattranscripts  │  │ announcements │ │
│  │  ├──────────────────┤  ├──────────────────┤  ├───────────────┤ │
│  │  │ _id              │  │ _id              │  │ _id           │ │
│  │  │ userId           │  │ userId           │  │ title         │ │
│  │  │ sessionId        │  │ sessionId        │  │ content       │ │
│  │  │ content          │  │ title            │  │ type          │ │
│  │  │ senderType       │  │ messages[]       │  │ priority      │ │
│  │  │ sentAt           │  │ messageCount     │  │ isVisible     │ │
│  │  └──────────────────┘  │ startedAt        │  │ startDate     │ │
│  │                        │ endedAt          │  │ endDate       │ │
│  │                        └──────────────────┘  └───────────────┘ │
│  │                                                                  │
│  │  ┌──────────────────────────────────────────────────────────┐  │
│  │  │              contentreports                              │  │
│  │  ├──────────────────────────────────────────────────────────┤  │
│  │  │ _id                                                      │  │
│  │  │ userId (reporter)                                        │  │
│  │  │ historyId (reported content)                            │  │
│  │  │ reason                                                   │  │
│  │  │ details                                                  │  │
│  │  │ status                                                   │  │
│  │  │ reviewedBy                                               │  │
│  │  │ result                                                   │  │
│  │  │ reportedAt                                               │  │
│  │  │ reviewedAt                                               │  │
│  │  └──────────────────────────────────────────────────────────┘  │
│  └──────────────────────────────────────────────────────────────────┘
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────────┐
│  │  CONFIG COLLECTIONS                                              │
│  ├──────────────────────────────────────────────────────────────────┤
│  │                                                                   │
│  │  ┌──────────────────────────────────────────────────────────┐   │
│  │  │              serviceconfigs                              │   │
│  │  ├──────────────────────────────────────────────────────────┤   │
│  │  │ _id                                                      │   │
│  │  │ service (outfit/background/face)                        │   │
│  │  │ fee                                                      │   │
│  │  │ description                                              │   │
│  │  │ parameters                                               │   │
│  │  │ isActive                                                 │   │
│  │  └──────────────────────────────────────────────────────────┘   │
│  └──────────────────────────────────────────────────────────────────┘
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────┐
│                         INDEXES STRATEGY                               │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  users:                                                                 │
│    - { email: 1 } UNIQUE                                               │
│    - { googleId: 1 }                                                   │
│    - { role: 1 }                                                       │
│                                                                         │
│  premiums:                                                              │
│    - { userId: 1, status: 1 }                                          │
│    - { userId: 1, endDate: 1 }                                         │
│                                                                         │
│  histories:                                                             │
│    - { userId: 1, createdAt: -1 }                                      │
│    - { moderationStatus: 1 }                                           │
│    - { promptId: 1 }                                                   │
│                                                                         │
│  prompts:                                                               │
│    - { name: 1 } UNIQUE                                                │
│    - { isActive: 1 }                                                   │
│    - { gender: 1 }                                                     │
│                                                                         │
│  sessions:                                                              │
│    - { userId: 1, isActive: 1 }                                        │
│    - { tokenId: 1 } UNIQUE                                             │
│    - { expiresAt: 1 } TTL (auto-delete expired)                       │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 7. KIẾN TRÚC DEPLOYMENT (DEPLOYMENT ARCHITECTURE)

```
┌────────────────────────────────────────────────────────────────────────┐
│                      PRODUCTION ENVIRONMENT                            │
└────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────┐
│                         CDN LAYER                                      │
│                      (Cloudflare / CloudFront)                         │
├────────────────────────────────────────────────────────────────────────┤
│  • Static Assets Caching                                               │
│  • DDoS Protection                                                     │
│  • SSL/TLS Termination                                                 │
│  • Geographic Distribution                                             │
└────────────────────────────┬───────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────┐
│                      LOAD BALANCER                                     │
│                      (Nginx / AWS ELB)                                 │
├────────────────────────────────────────────────────────────────────────┤
│  • Round Robin Distribution                                            │
│  • Health Checks                                                       │
│  • SSL Offloading                                                      │
│  • Request Routing                                                     │
└────────────────────────────┬───────────────────────────────────────────┘
                             │
                ┌────────────┴────────────┐
                │                         │
                ▼                         ▼
┌───────────────────────┐     ┌───────────────────────┐
│   APP SERVER 1        │     │   APP SERVER 2        │
│   (Node.js + Express) │     │   (Node.js + Express) │
├───────────────────────┤     ├───────────────────────┤
│  • Port: 5000         │     │  • Port: 5000         │
│  • PM2 Process Mgr    │     │  • PM2 Process Mgr    │
│  • Auto Restart       │     │  • Auto Restart       │
│  • Log Rotation       │     │  • Log Rotation       │
└───────────┬───────────┘     └───────────┬───────────┘
            │                             │
            └──────────────┬──────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────────────┐
│                      SHARED SERVICES                                   │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐│
│  │  MongoDB Atlas   │  │   Cloudinary     │  │   Redis Cache        ││
│  │  (Database)      │  │   (File Storage) │  │   (Session Store)    ││
│  └──────────────────┘  └──────────────────┘  └──────────────────────┘│
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────┐
│                      MONITORING & LOGGING                              │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐│
│  │  Application     │  │   Error          │  │   Performance        ││
│  │  Logs            │  │   Tracking       │  │   Monitoring         ││
│  │  (Winston)       │  │   (Sentry)       │  │   (New Relic)        ││
│  └──────────────────┘  └──────────────────┘  └──────────────────────┘│
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 8. KIẾN TRÚC MICROSERVICES (FUTURE)

```
┌────────────────────────────────────────────────────────────────────────┐
│                   MICROSERVICES ARCHITECTURE (FUTURE)                  │
└────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │  API        │
                              │  Gateway    │
                              └──────┬──────┘
                                     │
                ┌────────────────────┼────────────────────┐
                │                    │                    │
                ▼                    ▼                    ▼
┌───────────────────────┐ ┌──────────────────┐ ┌──────────────────────┐
│   Auth Service        │ │  AI Service      │ │  Payment Service     │
│   (Port: 3001)        │ │  (Port: 3002)    │ │  (Port: 3003)        │
├───────────────────────┤ ├──────────────────┤ ├──────────────────────┤
│ • User Registration   │ │ • Image Gen      │ │ • MoMo Integration   │
│ • Login/Logout        │ │ • Model Mgmt     │ │ • Transaction Mgmt   │
│ • JWT Management      │ │ • Queue Jobs     │ │ • Refund Processing  │
│ • OAuth Integration   │ │ • Result Cache   │ │ • Invoice Generation │
└───────────────────────┘ └──────────────────┘ └──────────────────────┘

                ▼                    ▼                    ▼
┌───────────────────────┐ ┌──────────────────┐ ┌──────────────────────┐
│  Content Service      │ │  Notification    │ │  Analytics Service   │
│  (Port: 3004)         │ │  Service         │ │  (Port: 3006)        │
├───────────────────────┤ │  (Port: 3005)    │ ├──────────────────────┤
│ • Moderation          │ ├──────────────────┤ │ • Usage Tracking     │
│ • Prompt Management   │ │ • Email Service  │ │ • Revenue Reports    │
│ • History Storage     │ │ • Push Notif     │ │ • User Behavior      │
│ • Report Handling     │ │ • SMS Service    │ │ • A/B Testing        │
└───────────────────────┘ └──────────────────┘ └──────────────────────┘

                              ┌─────────────┐
                              │  Message    │
                              │  Queue      │
                              │  (RabbitMQ) │
                              └─────────────┘
```

---

**Tài liệu này mô tả đầy đủ kiến trúc hệ thống EternaPicSHT AI Studio**

**Phiên bản**: 1.0  
**Ngày cập nhật**: 04/12/2024  
**Người soạn**: AI Studio Development Team
